{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Appium Lifecycle Events",
  "description": "Event schemas for Appium lifecycle phases emitted by the EnsureDevice node",
  "definitions": {
    "DevicePrerequisite": {
      "type": "object",
      "required": ["deviceId", "packageName", "appActivity", "adbAvailable", "deviceVisible", "deviceOnline", "packageInstalled", "validationDurationMs", "validAt", "errors"],
      "properties": {
        "deviceId": { "type": "string" },
        "packageName": { "type": "string" },
        "appActivity": { "type": "string" },
        "adbAvailable": { "type": "boolean" },
        "deviceVisible": { "type": "boolean" },
        "deviceOnline": { "type": "boolean" },
        "packageInstalled": { "type": "boolean" },
        "validationDurationMs": { "type": "number", "minimum": 0 },
        "validAt": { "type": "string", "format": "date-time" },
        "errors": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["check", "message"],
            "properties": {
              "check": { "type": "string" },
              "message": { "type": "string" }
            }
          }
        }
      }
    },
    "HealthStatus": {
      "type": "object",
      "required": ["ready", "message"],
      "properties": {
        "ready": { "type": "boolean" },
        "message": { "type": "string" }
      }
    },
    "ErrorDetail": {
      "type": "object",
      "required": ["message"],
      "properties": {
        "message": { "type": "string" },
        "code": { "type": "string" },
        "retryable": { "type": "boolean" }
      }
    },
    "BasePayload": {
      "type": "object",
      "required": ["phase", "success", "durationMs", "timestamp"],
      "properties": {
        "phase": {
          "type": "string",
          "enum": ["device_check", "health_check", "starting", "ready", "failed"]
        },
        "success": { "type": "boolean" },
        "durationMs": { "type": "number", "minimum": 0 },
        "timestamp": { "type": "string", "format": "date-time" }
      }
    }
  },
  "oneOf": [
    {
      "title": "Device Check Event",
      "type": "object",
      "required": ["kind", "payload", "sequence", "ts"],
      "properties": {
        "kind": { "const": "agent.appium.device_check" },
        "payload": {
          "allOf": [
            { "$ref": "#/definitions/BasePayload" },
            {
              "properties": {
                "phase": { "const": "device_check" },
                "devicePrerequisite": { "$ref": "#/definitions/DevicePrerequisite" },
                "error": { "$ref": "#/definitions/ErrorDetail" }
              }
            }
          ]
        },
        "sequence": { "type": "number", "minimum": 0 },
        "ts": { "type": "string", "format": "date-time" }
      }
    },
    {
      "title": "Health Check Event",
      "type": "object",
      "required": ["kind", "payload", "sequence", "ts"],
      "properties": {
        "kind": { "const": "agent.appium.health_check" },
        "payload": {
          "allOf": [
            { "$ref": "#/definitions/BasePayload" },
            {
              "properties": {
                "phase": { "const": "health_check" },
                "healthStatus": { "$ref": "#/definitions/HealthStatus" },
                "error": { "$ref": "#/definitions/ErrorDetail" }
              }
            }
          ]
        },
        "sequence": { "type": "number", "minimum": 0 },
        "ts": { "type": "string", "format": "date-time" }
      }
    },
    {
      "title": "Starting Event",
      "type": "object",
      "required": ["kind", "payload", "sequence", "ts"],
      "properties": {
        "kind": { "const": "agent.appium.starting" },
        "payload": {
          "allOf": [
            { "$ref": "#/definitions/BasePayload" },
            {
              "properties": {
                "phase": { "const": "starting" },
                "appiumPid": { "type": "number", "minimum": 1 },
                "error": { "$ref": "#/definitions/ErrorDetail" }
              }
            }
          ]
        },
        "sequence": { "type": "number", "minimum": 0 },
        "ts": { "type": "string", "format": "date-time" }
      }
    },
    {
      "title": "Ready Event",
      "type": "object",
      "required": ["kind", "payload", "sequence", "ts"],
      "properties": {
        "kind": { "const": "agent.appium.ready" },
        "payload": {
          "allOf": [
            { "$ref": "#/definitions/BasePayload" },
            {
              "required": ["appiumPid", "healthStatus"],
              "properties": {
                "phase": { "const": "ready" },
                "appiumPid": { "type": "number", "minimum": 1 },
                "healthStatus": { "$ref": "#/definitions/HealthStatus" }
              }
            }
          ]
        },
        "sequence": { "type": "number", "minimum": 0 },
        "ts": { "type": "string", "format": "date-time" }
      }
    },
    {
      "title": "Failed Event",
      "type": "object",
      "required": ["kind", "payload", "sequence", "ts"],
      "properties": {
        "kind": { "const": "agent.appium.failed" },
        "payload": {
          "allOf": [
            { "$ref": "#/definitions/BasePayload" },
            {
              "required": ["error"],
              "properties": {
                "phase": { "const": "failed" },
                "success": { "const": false },
                "error": { "$ref": "#/definitions/ErrorDetail" }
              }
            }
          ]
        },
        "sequence": { "type": "number", "minimum": 0 },
        "ts": { "type": "string", "format": "date-time" }
      }
    }
  ]
}

