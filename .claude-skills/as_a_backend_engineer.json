{
  "name": "Backend Engineer Mode",
  "version": "1.0.0",
  "description": "Configuration for backend engineering tasks in ScreenGraph, defining clear boundaries between encore test and encore run environments.",
  "scope": "backend",
  
  "environment_boundaries": {
    "encore_test": {
      "purpose": "Isolated testing with ephemeral resources",
      "runtime": "isolated_encore_runtime",
      "database": "ephemeral_test_db",
      "pubsub": "isolated_topics_require_explicit_imports",
      "use_cases": [
        "Unit tests for endpoints and domain logic",
        "Integration tests with imported subscriptions",
        "Fast feedback during development",
        "CI/CD pipeline testing"
      ],
      "commands": [
        "cd backend && encore test",
        "cd backend && encore test path/to/test.ts"
      ],
      "critical_rules": [
        "PubSub subscriptions MUST be explicitly imported in test files",
        "Import statement: import \"../path/to/subscription\"",
        "Without import, jobs publish but workers never start (stays 'queued')",
        "Test database is ephemeral and isolated"
      ],
      "pros": [
        "Fast test execution",
        "Clean isolation between tests",
        "Type-safe with Encore validation",
        "No external dependencies (except integration tests)"
      ],
      "cons": [
        "Separate from encore run runtime",
        "PubSub requires explicit imports",
        "Not connected to real external services"
      ]
    },
    
    "encore_run": {
      "purpose": "Full stack development with all services and workers",
      "runtime": "complete_encore_application",
      "database": "local_persistent_db",
      "pubsub": "all_subscriptions_active_automatically",
      "use_cases": [
        "Local development with hot reload",
        "Manual API testing via dashboard or curl",
        "Debugging PubSub flows with real workers",
        "Integration with external services (Appium, devices)"
      ],
      "commands": [
        "cd backend && encore run",
        "bun run dev (via Turborepo harness)",
        "cd .cursor && task founder:servers:start"
      ],
      "services": {
        "backend": "http://localhost:4000",
        "dashboard": "http://localhost:9400"
      },
      "critical_rules": [
        "NOT for running tests (use encore test instead)",
        "All PubSub subscriptions active by default",
        "Use for manual testing and debugging",
        "Connected to external services (Appium, devices)"
      ],
      "pros": [
        "Full system running with hot reload",
        "Real-time logging and tracing",
        "Encore dashboard for API testing",
        "All workers and subscriptions active"
      ],
      "cons": [
        "Slower startup than encore test",
        "Requires external dependencies",
        "Not suitable for automated testing"
      ]
    }
  },
  
  "testing_patterns": {
    "unit_test": {
      "description": "Test single endpoint or function in isolation",
      "environment": "encore_test",
      "requires_imports": false,
      "example": "backend/run/start.test.ts"
    },
    "integration_test_database": {
      "description": "Test endpoint with database interaction",
      "environment": "encore_test",
      "requires_imports": false,
      "example": "backend/agent/persistence/run-db.repo.test.ts"
    },
    "integration_test_pubsub": {
      "description": "Test PubSub flow with worker subscription",
      "environment": "encore_test",
      "requires_imports": true,
      "import_statement": "import \"../orchestrator/subscription\"",
      "example": "backend/agent/tests/metrics.test.ts"
    },
    "metrics_test": {
      "description": "Validate agent metrics against deterministic expectations",
      "environment": "encore_test",
      "requires_imports": true,
      "requires_external": {
        "appium": "Start manually via Appium Inspector (not automated)",
        "android_device": "Start manually via Android Studio (not automated)",
        "note": "Task command checks prerequisites but does NOT auto-start services"
      },
      "command": "cd .cursor && task backend:integration:metrics",
      "example": "backend/agent/tests/metrics.test.ts"
    }
  },
  
  "encore_mcp_tools": {
    "description": "Use Encore MCP tools for service introspection and debugging",
    "common_tools": [
      {
        "name": "mcp_encore-mcp_get_services",
        "purpose": "Inspect services and endpoints",
        "use_case": "Understanding endpoint signatures before writing tests"
      },
      {
        "name": "mcp_encore-mcp_query_database",
        "purpose": "Query test database during debugging",
        "use_case": "Inspecting run status, events, or graph data"
      },
      {
        "name": "mcp_encore-mcp_get_traces",
        "purpose": "List and analyze request traces",
        "use_case": "Debugging slow tests or request flows"
      },
      {
        "name": "mcp_encore-mcp_get_pubsub",
        "purpose": "Inspect PubSub topics and subscriptions",
        "use_case": "Verifying subscription configuration"
      },
      {
        "name": "mcp_encore-mcp_get_databases",
        "purpose": "Get database schema and table structure",
        "use_case": "Writing queries or understanding relationships"
      }
    ]
  },
  
  "task_commands": {
    "test_all": "cd .cursor && task backend:test",
    "test_integration_metrics": {
      "command": "cd .cursor && task backend:integration:metrics",
      "prerequisites": [
        "Start Appium manually via Appium Inspector",
        "Start Android emulator via Android Studio",
        "Ensure backend is healthy (task checks this)",
        "Task verifies ADB, device, Appium, backend health before running test"
      ]
    },
    "test_specific": "cd backend && encore test path/to/test.ts",
    "test_watch": "cd backend && bun test:watch",
    "start_backend": "cd backend && encore run",
    "check_health": "cd .cursor && task backend:health",
    "db_migrate": "cd .cursor && task backend:db:migrate",
    "db_shell": "cd .cursor && task backend:db:shell"
  },
  
  "default_timeouts": {
    "unit_test": "10s",
    "integration_test_database": "30s",
    "integration_test_pubsub": "60s",
    "metrics_test": "5min",
    "all_commands": "30s"
  },
  
  "skills": {
    "backend_testing": ".claude-skills/backend-testing_skill/SKILL.md",
    "backend_debugging": ".claude-skills/backend-debugging_skill/SKILL.md"
  },
  
  "rules": {
    "coding_standards": ".cursor/rules/backend_coding_rules.mdc",
    "founder_rules": ".cursor/rules/founder_rules.mdc"
  },
  
  "critical_patterns": {
    "pubsub_in_tests": {
      "rule": "ALWAYS import subscription at top of test file for PubSub tests",
      "import_statement": "import \"../orchestrator/subscription\"",
      "reason": "encore test only loads subscriptions that are imported",
      "without_import": "Jobs will publish but never be consumed (stays 'queued')"
    },
    "metrics_validation": {
      "rule": "Assert both event metrics AND database state",
      "reason": "Ensures consistency between reported metrics and actual data",
      "example": "backend/agent/tests/metrics.test.ts"
    },
    "environment_variables": {
      "rule": "Use env vars for test configuration and expectations",
      "config_file": "backend/config/env.ts",
      "example": "EXPECTED_UNIQUE_SCREENS_DISCOVERED"
    },
    "structured_logging": {
      "rule": "Use encore.dev/log with required fields: module, actor, runId",
      "never": "console.log (prohibited by founder rules)"
    }
  }
}

