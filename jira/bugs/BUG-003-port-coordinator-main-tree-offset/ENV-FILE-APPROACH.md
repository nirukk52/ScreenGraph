# Single .env File Approach (Better Alternative)

**Purpose**: Centralized environment configuration instead of script-based variables

---

## ðŸŽ¯ The Better Way: Centralized .env

Instead of passing environment variables through scripts, use a single `.env` file at the root.

### Benefits

1. **Single Source of Truth**: All config in one place
2. **Standard Practice**: Industry standard for environment config
3. **Vite Native**: Vite automatically loads `.env` files
4. **Git-Friendly**: `.env.local` for worktree-specific overrides
5. **Discoverable**: Easy to see all configuration

---

## ðŸ“ File Structure

```
/ScreenGraph (Main Tree)
â”œâ”€â”€ .env                    # Default config (committed)
â”œâ”€â”€ .env.local             # Local overrides (gitignored)
â”œâ”€â”€ .env.example           # Template (committed)
â”œâ”€â”€ backend/
â””â”€â”€ frontend/
```

### Worktrees

```
/ScreenGraph-worktrees/
â”œâ”€â”€ feature-xyz/
â”‚   â”œâ”€â”€ .env.local         # Worktree-specific config (gitignored)
â”‚   â”œâ”€â”€ backend/
â”‚   â””â”€â”€ frontend/
```

---

## ðŸ“ File Contents

### .env (Main Tree - Committed)

```bash
# .env (Main Tree Configuration)
# This file is committed to Git

# Service: Main tree always uses default ports
VITE_BACKEND_BASE_URL=http://localhost:4000
BACKEND_PORT=4000
FRONTEND_PORT=5173
ENCORE_DASHBOARD_PORT=9400
APPIUM_PORT=4723

# Mode
WORKTREE_MODE=main
NODE_ENV=development

# Feature Flags
ENABLE_MULTI_WORKTREE=true
```

### .env.example (Template - Committed)

```bash
# .env.example (Template for new worktrees)
# Copy this to .env.local and customize

# Backend URL (Vite will use this for API calls)
VITE_BACKEND_BASE_URL=http://localhost:4000

# Service Ports
BACKEND_PORT=4000
FRONTEND_PORT=5173
ENCORE_DASHBOARD_PORT=9400
APPIUM_PORT=4723

# Worktree Mode (main | worktree)
WORKTREE_MODE=main

# Development
NODE_ENV=development
```

### .env.local (Worktree - Gitignored)

```bash
# .env.local (Worktree-specific overrides)
# This file is gitignored - safe for local config

# Auto-generated by port-coordinator
VITE_BACKEND_BASE_URL=http://localhost:4008
BACKEND_PORT=4008
FRONTEND_PORT=5181
ENCORE_DASHBOARD_PORT=9408
APPIUM_PORT=4731

# Worktree metadata
WORKTREE_MODE=worktree
WORKTREE_NAME=Px8w6
```

---

## ðŸ”§ Implementation

### Step 1: Create .env Files

```bash
# Create main .env
cat > .env << 'EOF'
# Main Tree Configuration
VITE_BACKEND_BASE_URL=http://localhost:4000
BACKEND_PORT=4000
FRONTEND_PORT=5173
ENCORE_DASHBOARD_PORT=9400
APPIUM_PORT=4723
WORKTREE_MODE=main
NODE_ENV=development
EOF

# Create example
cp .env .env.example

# Add .env.local to .gitignore
echo ".env.local" >> .gitignore
```

### Step 2: Update Frontend to Use .env

```typescript
// frontend/src/lib/getEncoreClient.ts

/**
 * Get backend URL from environment variables.
 * 
 * Vite automatically loads:
 * 1. .env (committed defaults)
 * 2. .env.local (gitignored overrides)
 * 
 * VITE_ prefix required for Vite to expose to browser.
 */
export function getBackendUrl(): string {
  const backendUrl = import.meta.env.VITE_BACKEND_BASE_URL;
  
  if (!backendUrl) {
    throw new Error(
      'VITE_BACKEND_BASE_URL not set. ' +
      'Check that .env file exists at project root.'
    );
  }
  
  console.log(`[Frontend] Using backend: ${backendUrl}`);
  return backendUrl;
}

export const client = getBackendUrl();
```

### Step 3: Update Port Coordinator (Auto-Generate .env.local)

```javascript
// scripts/port-coordinator.mjs

async function resolvePorts() {
  const worktree = detectWorktreeName();
  const isMainTree = worktree === "ScreenGraph";
  
  if (isMainTree) {
    // Main tree: use .env (defaults)
    console.log("Main tree: Using .env defaults");
    return loadEnvFile('.env');
  }
  
  // Worktree: generate .env.local
  const ports = await assignPorts(worktree);
  await writeEnvLocal(worktree, ports);
  
  console.log(`Worktree ${worktree}: Generated .env.local`);
  return ports;
}

async function writeEnvLocal(worktree, ports) {
  const envLocal = `
# Auto-generated by port-coordinator.mjs
# DO NOT EDIT MANUALLY

# Backend URL for frontend
VITE_BACKEND_BASE_URL=http://localhost:${ports.backend}

# Service Ports
BACKEND_PORT=${ports.backend}
FRONTEND_PORT=${ports.frontend}
ENCORE_DASHBOARD_PORT=${ports.dashboard}
APPIUM_PORT=${ports.appium}

# Worktree Metadata
WORKTREE_MODE=worktree
WORKTREE_NAME=${worktree}

# Generated at ${new Date().toISOString()}
`.trim();

  await writeFile('.env.local', envLocal);
}
```

### Step 4: Update Start Scripts

```bash
# scripts/start-backend.sh
#!/bin/bash
set -e

# Load .env (and .env.local if exists)
if [ -f .env ]; then
  export $(cat .env | grep -v '^#' | xargs)
fi

if [ -f .env.local ]; then
  export $(cat .env.local | grep -v '^#' | xargs)
fi

echo "ðŸš€ Starting backend on port ${BACKEND_PORT}"
cd backend
encore run --port ${BACKEND_PORT}
```

```bash
# scripts/start-frontend.sh
#!/bin/bash
set -e

# Load .env (and .env.local if exists)
if [ -f .env ]; then
  export $(cat .env | grep -v '^#' | xargs)
fi

if [ -f .env.local ]; then
  export $(cat .env.local | grep -v '^#' | xargs)
fi

echo "ðŸš€ Starting frontend on port ${FRONTEND_PORT}"
echo "   Backend: ${VITE_BACKEND_BASE_URL}"

cd frontend
bun run dev --port ${FRONTEND_PORT}
```

---

## ðŸŽ¯ Workflow Examples

### Main Tree Development

```bash
cd ~/ScreenGraph/Code/ScreenGraph

# .env already exists (committed)
cat .env
# VITE_BACKEND_BASE_URL=http://localhost:4000
# BACKEND_PORT=4000
# FRONTEND_PORT=5173

# Start services (uses .env)
./scripts/start-backend.sh   # Port 4000
./scripts/start-frontend.sh  # Port 5173

# Frontend automatically uses http://localhost:4000
```

### Worktree Development

```bash
cd ~/ScreenGraph-worktrees/feature-xyz

# Generate .env.local
bun ../ScreenGraph/scripts/port-coordinator.mjs

# This creates .env.local:
cat .env.local
# VITE_BACKEND_BASE_URL=http://localhost:4008
# BACKEND_PORT=4008
# FRONTEND_PORT=5181

# Start services (uses .env + .env.local)
./scripts/start-backend.sh   # Port 4008 (from .env.local)
./scripts/start-frontend.sh  # Port 5181 (from .env.local)

# Frontend automatically uses http://localhost:4008
```

### Switching Worktrees

```bash
# Terminal stays in same worktree
cd ~/ScreenGraph-worktrees/feature-xyz

# .env.local is already set
# No need to re-export variables
# Just start services

./scripts/start-backend.sh
./scripts/start-frontend.sh
```

---

## ðŸ“Š Comparison: Script-Based vs .env File

### Current Approach (Script-Based)

```bash
# Pass env vars through script
eval "$(bun ./scripts/port-coordinator.mjs --no-summary)"
export VITE_BACKEND_BASE_URL="http://localhost:${BACKEND_PORT}"
cd frontend && bun run dev --port ${FRONTEND_PORT}
```

**Pros**:
- Works
- Dynamic port assignment

**Cons**:
- âŒ Variables lost when terminal closes
- âŒ Need to re-run script in each new terminal
- âŒ Not discoverable (can't see current config)
- âŒ Hard to debug (where did BACKEND_PORT come from?)
- âŒ Not standard practice

### Proposed Approach (.env File)

```bash
# Port coordinator generates .env.local
bun ./scripts/port-coordinator.mjs

# Start services (auto-loads .env + .env.local)
./scripts/start-backend.sh
./scripts/start-frontend.sh
```

**Pros**:
- âœ… Persists across terminal sessions
- âœ… Discoverable (just cat .env.local)
- âœ… Standard practice (everyone knows .env files)
- âœ… Vite native support (auto-loads)
- âœ… Easy to debug (see exactly what's configured)
- âœ… Git-friendly (.env.local gitignored)

**Cons**:
- Need to regenerate .env.local if switching worktrees (but that's rare)

---

## ðŸ” Security & Git

### .gitignore

```bash
# Environment
.env.local          # Worktree-specific (never commit)
.env.*.local        # Any local overrides

# Keep committed
# .env              # Default config (safe to commit)
# .env.example      # Template (safe to commit)
```

### What Gets Committed

```
âœ… .env              # Default main tree config
âœ… .env.example      # Template for new worktrees
âŒ .env.local        # Worktree-specific (gitignored)
âŒ .env.production   # If used (gitignored)
```

---

## ðŸš€ Migration Steps

### Phase 1: Add .env Files (15 min)

```bash
# 1. Create .env
cat > .env << 'EOF'
VITE_BACKEND_BASE_URL=http://localhost:4000
BACKEND_PORT=4000
FRONTEND_PORT=5173
ENCORE_DASHBOARD_PORT=9400
APPIUM_PORT=4723
WORKTREE_MODE=main
NODE_ENV=development
EOF

# 2. Create example
cp .env .env.example

# 3. Update .gitignore
echo ".env.local" >> .gitignore

# 4. Commit
git add .env .env.example .gitignore
git commit -m "Add centralized .env configuration"
```

### Phase 2: Update Frontend (10 min)

```typescript
// frontend/src/lib/getEncoreClient.ts
export function getBackendUrl(): string {
  const backendUrl = import.meta.env.VITE_BACKEND_BASE_URL;
  
  if (!backendUrl) {
    throw new Error('VITE_BACKEND_BASE_URL not set');
  }
  
  return backendUrl;
}
```

### Phase 3: Update Port Coordinator (20 min)

- Modify `port-coordinator.mjs` to write `.env.local`
- Remove `--no-summary` flag (just generate file)

### Phase 4: Update Start Scripts (10 min)

- Add .env loading to start scripts
- Remove manual export statements

### Phase 5: Test (10 min)

```bash
# Main tree
cd ~/ScreenGraph
./scripts/start-backend.sh
./scripts/start-frontend.sh
# Should use port 4000/5173

# Worktree
cd ~/ScreenGraph-worktrees/Px8w6
bun ../ScreenGraph/scripts/port-coordinator.mjs
./scripts/start-backend.sh
./scripts/start-frontend.sh
# Should use port 4008/5181
```

**Total Time**: 65 minutes

---

## âœ… Benefits Summary

1. **Persistence**: Config survives terminal restarts
2. **Discoverability**: `cat .env.local` shows current config
3. **Standard**: Everyone understands .env files
4. **Vite Native**: Automatic loading, no custom code
5. **Git-Friendly**: .env.local gitignored, no conflicts
6. **Debugging**: Easy to see what's configured
7. **Separation**: Main tree (.env) vs worktree (.env.local)

---

## ðŸŽ¯ Recommendation

**Replace script-based environment variables with .env files**

**Why**:
- More standard
- More persistent
- More discoverable
- Less error-prone
- Better developer experience

**Migration**:
- Low risk (1 hour)
- Immediate benefits
- Cleaner than current approach

**Update migration plan to use this approach instead of script exports.**

