# Production .env Approach with dotenv + dotenvx + envalid

**Purpose**: Industry-standard environment management with type safety and encryption

**Stack**: `dotenv` + `dotenvx` + `envalid` (recommended for most teams)

---

## üéØ Why This Stack

### dotenv
- ‚úÖ Rock-solid, industry standard
- ‚úÖ 47M+ weekly downloads
- ‚úÖ Works everywhere (Node, Bun, Deno)

### dotenvx
- ‚úÖ Multi-environment support
- ‚úÖ Encrypted `.env.vault` for CI/production
- ‚úÖ Backward compatible with dotenv
- ‚úÖ No external dependencies

### envalid
- ‚úÖ Type-safe environment validation
- ‚úÖ Catch missing vars at startup
- ‚úÖ Automatic type coercion
- ‚úÖ Clear error messages

---

## üì¶ Installation

```bash
# Backend
cd backend
bun add dotenv dotenvx envalid

# Frontend (Vite has built-in dotenv)
cd frontend
bun add envalid
# Note: Vite auto-loads .env files, no dotenv needed
```

---

## üìÅ File Structure

```
/ScreenGraph (Main Tree)
‚îú‚îÄ‚îÄ .env                    # Defaults (committed)
‚îú‚îÄ‚îÄ .env.local             # Local overrides (gitignored)
‚îú‚îÄ‚îÄ .env.vault             # Encrypted secrets (committed)
‚îú‚îÄ‚îÄ .env.example           # Template (committed)
‚îú‚îÄ‚îÄ .envrc                 # direnv config (optional)
‚îú‚îÄ‚îÄ .gitignore             # Ignore .env.local, .env.keys
‚îÇ
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ env.ts     # Type-safe env validation
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ
‚îî‚îÄ‚îÄ frontend/
    ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îî‚îÄ‚îÄ lib/
    ‚îÇ       ‚îî‚îÄ‚îÄ env.ts     # Type-safe env validation
    ‚îî‚îÄ‚îÄ package.json
```

---

## üìù Environment Files

### .env (Main Tree - Committed)

```bash
# .env
# Default configuration for main tree
# Committed to Git - no secrets here

# Backend URL (VITE_ prefix required for frontend access)
VITE_BACKEND_BASE_URL=http://localhost:4000

# Service Ports
BACKEND_PORT=4000
FRONTEND_PORT=5173
ENCORE_DASHBOARD_PORT=9400
APPIUM_PORT=4723

# Environment
NODE_ENV=development
WORKTREE_MODE=main

# Feature Flags
ENABLE_MULTI_WORKTREE=true
ENABLE_GRAPH_STREAM=true
```

### .env.local (Worktree - Gitignored)

```bash
# .env.local
# Auto-generated by port-coordinator.mjs
# Gitignored - worktree-specific overrides

VITE_BACKEND_BASE_URL=http://localhost:4008
BACKEND_PORT=4008
FRONTEND_PORT=5181
ENCORE_DASHBOARD_PORT=9408
APPIUM_PORT=4731

# Worktree Metadata
WORKTREE_MODE=worktree
WORKTREE_NAME=Px8w6

# Generated: 2025-11-07T18:30:00Z
```

### .env.vault (Encrypted Secrets - Committed)

```bash
# .env.vault
# Encrypted secrets for CI/production
# Safe to commit to Git

#/-------------------.env.vault---------------------/
#/         cloud-agnostic vaulting standard         /
#/   [how it works](https://dotenvx.com/docs)       /
#/--------------------------------------------------/

# development
DOTENV_VAULT_DEVELOPMENT="encrypted_value_here"

# production
DOTENV_VAULT_PRODUCTION="encrypted_value_here"

# ci
DOTENV_VAULT_CI="encrypted_value_here"
```

### .env.example (Template - Committed)

```bash
# .env.example
# Template for new setups
# Copy to .env and customize

# Backend URL
VITE_BACKEND_BASE_URL=http://localhost:4000

# Service Ports
BACKEND_PORT=4000
FRONTEND_PORT=5173
ENCORE_DASHBOARD_PORT=9400
APPIUM_PORT=4723

# Environment
NODE_ENV=development
WORKTREE_MODE=main

# Secrets (replace with real values)
DATABASE_URL=postgresql://user:pass@localhost:5432/db
API_KEY=your-api-key-here
```

---

## üîß Backend Implementation

### backend/src/config/env.ts (Type-Safe Validation)

```typescript
import { cleanEnv, str, port, url, bool } from 'envalid';
import 'dotenv/config'; // Auto-load .env files

/**
 * Type-safe, validated environment configuration.
 * 
 * Validates at startup:
 * - All required vars are present
 * - Types are correct (ports are numbers, URLs are valid)
 * - Provides helpful error messages if misconfigured
 * 
 * Usage:
 *   import { env } from './config/env';
 *   console.log(env.BACKEND_PORT); // number (type-safe!)
 */
export const env = cleanEnv(process.env, {
  // Backend URL (for frontend)
  VITE_BACKEND_BASE_URL: url({
    default: 'http://localhost:4000',
    desc: 'Backend API base URL',
    example: 'http://localhost:4008'
  }),
  
  // Service Ports
  BACKEND_PORT: port({
    default: 4000,
    desc: 'Encore backend port'
  }),
  
  FRONTEND_PORT: port({
    default: 5173,
    desc: 'Vite frontend port'
  }),
  
  ENCORE_DASHBOARD_PORT: port({
    default: 9400,
    desc: 'Encore dashboard port'
  }),
  
  APPIUM_PORT: port({
    default: 4723,
    desc: 'Appium server port'
  }),
  
  // Environment
  NODE_ENV: str({
    choices: ['development', 'test', 'production'],
    default: 'development'
  }),
  
  WORKTREE_MODE: str({
    choices: ['main', 'worktree'],
    default: 'main',
    desc: 'Main tree or worktree mode'
  }),
  
  WORKTREE_NAME: str({
    default: 'ScreenGraph',
    desc: 'Worktree name (auto-detected)'
  }),
  
  // Feature Flags
  ENABLE_MULTI_WORKTREE: bool({
    default: true,
    desc: 'Enable multi-worktree support'
  }),
  
  ENABLE_GRAPH_STREAM: bool({
    default: true,
    desc: 'Enable graph WebSocket streaming'
  })
});

// Re-export for convenience
export const {
  VITE_BACKEND_BASE_URL,
  BACKEND_PORT,
  FRONTEND_PORT,
  ENCORE_DASHBOARD_PORT,
  APPIUM_PORT,
  NODE_ENV,
  WORKTREE_MODE,
  WORKTREE_NAME
} = env;

// Log configuration on startup (development only)
if (env.isDev) {
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log('üîß Environment Configuration');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log(`Mode: ${WORKTREE_MODE} (${WORKTREE_NAME})`);
  console.log(`Backend: http://localhost:${BACKEND_PORT}`);
  console.log(`Frontend: http://localhost:${FRONTEND_PORT}`);
  console.log(`Dashboard: http://localhost:${ENCORE_DASHBOARD_PORT}`);
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
}
```

### backend/src/index.ts (Use Validated Config)

```typescript
import { env, BACKEND_PORT } from './config/env';

// Environment is already validated at import time
// If any required vars are missing, app won't start

console.log(`üöÄ Starting Encore backend on port ${BACKEND_PORT}`);

// All env vars are type-safe
if (env.ENABLE_GRAPH_STREAM) {
  console.log('‚úÖ Graph streaming enabled');
}
```

---

## üé® Frontend Implementation

### frontend/src/lib/env.ts (Type-Safe Validation)

```typescript
import { cleanEnv, url, port, str, bool } from 'envalid';

/**
 * Type-safe, validated environment configuration for frontend.
 * 
 * Vite automatically loads .env files and exposes VITE_* vars.
 * We validate them here for type safety and helpful errors.
 * 
 * Usage:
 *   import { env } from '$lib/env';
 *   const response = await fetch(`${env.VITE_BACKEND_BASE_URL}/health`);
 */
export const env = cleanEnv(import.meta.env, {
  // Backend URL (VITE_ prefix required!)
  VITE_BACKEND_BASE_URL: url({
    default: 'http://localhost:4000',
    desc: 'Backend API base URL',
    devDefault: 'http://localhost:4000'
  }),
  
  // Mode (Vite built-in)
  MODE: str({
    choices: ['development', 'production', 'test'],
    default: 'development'
  }),
  
  DEV: bool({
    default: true,
    desc: 'Development mode (Vite built-in)'
  })
});

// Re-export for convenience
export const { VITE_BACKEND_BASE_URL } = env;

// Log in development
if (env.DEV) {
  console.log(`[Frontend] Backend URL: ${VITE_BACKEND_BASE_URL}`);
}
```

### frontend/src/lib/getEncoreClient.ts (Use Validated Config)

```typescript
import { VITE_BACKEND_BASE_URL } from './env';

/**
 * Get the backend URL for API calls.
 * 
 * Now type-safe and validated at startup!
 * No more runtime errors from missing env vars.
 */
export function getBackendUrl(): string {
  // Already validated by env.ts - safe to use
  return VITE_BACKEND_BASE_URL;
}

export const client = getBackendUrl();
```

---

## üîÑ Port Coordinator Update

### scripts/port-coordinator.mjs (Generate .env.local)

```javascript
#!/usr/bin/env bun

import { writeFile } from 'fs/promises';
import { execSync } from 'child_process';

// Detect worktree name
function detectWorktreeName() {
  const gitRoot = execSync('git rev-parse --show-toplevel', { encoding: 'utf-8' }).trim();
  return gitRoot.split('/').pop();
}

// Assign ports (simplified)
async function assignPorts(worktree) {
  // Hash-based offset
  const hash = hashString(worktree);
  const offset = hash % 10;
  
  return {
    backend: 4000 + offset,
    frontend: 5173 + offset + 1,
    dashboard: 9400 + offset,
    appium: 4723 + offset + 1
  };
}

// Generate .env.local for worktree
async function generateEnvLocal(worktree, ports) {
  const content = `
# .env.local (Auto-generated)
# DO NOT EDIT MANUALLY
# Generated by: scripts/port-coordinator.mjs
# Generated at: ${new Date().toISOString()}

# Backend URL (VITE_ prefix required for frontend)
VITE_BACKEND_BASE_URL=http://localhost:${ports.backend}

# Service Ports
BACKEND_PORT=${ports.backend}
FRONTEND_PORT=${ports.frontend}
ENCORE_DASHBOARD_PORT=${ports.dashboard}
APPIUM_PORT=${ports.appium}

# Worktree Metadata
WORKTREE_MODE=worktree
WORKTREE_NAME=${worktree}
NODE_ENV=development

# Feature Flags (inherited from .env, can override)
ENABLE_MULTI_WORKTREE=true
ENABLE_GRAPH_STREAM=true
`.trim();

  await writeFile('.env.local', content);
  console.log(`‚úÖ Generated .env.local for worktree: ${worktree}`);
  console.log(`   Backend: http://localhost:${ports.backend}`);
  console.log(`   Frontend: http://localhost:${ports.frontend}`);
}

// Main
const worktree = detectWorktreeName();

if (worktree === 'ScreenGraph') {
  console.log('üè† Main tree detected - using .env defaults');
  process.exit(0);
}

const ports = await assignPorts(worktree);
await generateEnvLocal(worktree, ports);
```

---

## üîê Secrets Management (Optional)

### Encrypt Secrets for CI/Production

```bash
# Install dotenvx globally
bun install -g @dotenvx/dotenvx

# Encrypt .env file to .env.vault
dotenvx encrypt

# This creates:
# - .env.vault (encrypted, safe to commit)
# - .env.keys (decryption keys, NEVER commit)

# Add to .gitignore
echo ".env.keys" >> .gitignore

# Use in CI/production
DOTENV_KEY=your-key-here dotenvx run -- bun start
```

### .github/workflows/ci.yml (Example)

```yaml
name: CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Bun
        uses: oven-sh/setup-bun@v1
      
      - name: Install dependencies
        run: |
          cd backend && bun install
          cd frontend && bun install
      
      - name: Load encrypted .env
        run: dotenvx run -- bun test
        env:
          DOTENV_KEY: ${{ secrets.DOTENV_KEY }}
```

---

## üöÄ Start Scripts (Updated)

### scripts/start-backend.sh

```bash
#!/bin/bash
set -e

WORKTREE_NAME=$(basename $(git rev-parse --show-toplevel))

if [ "$WORKTREE_NAME" != "ScreenGraph" ]; then
    echo "‚ö†Ô∏è  Running backend on worktree: $WORKTREE_NAME"
    
    # Ensure .env.local exists
    if [ ! -f .env.local ]; then
        echo "‚ùå .env.local not found"
        echo "   Run: bun ./scripts/port-coordinator.mjs"
        exit 1
    fi
fi

echo "üöÄ Starting backend..."
echo ""

# dotenv automatically loads .env and .env.local
# envalid validates on startup
cd backend
bun run dev
```

### scripts/start-frontend.sh

```bash
#!/bin/bash
set -e

WORKTREE_NAME=$(basename $(git rev-parse --show-toplevel))

if [ "$WORKTREE_NAME" != "ScreenGraph" ]; then
    echo "‚ö†Ô∏è  Running frontend on worktree: $WORKTREE_NAME"
    
    # Ensure .env.local exists
    if [ ! -f .env.local ]; then
        echo "‚ùå .env.local not found"
        echo "   Run: bun ./scripts/port-coordinator.mjs"
        exit 1
    fi
fi

echo "üöÄ Starting frontend..."
echo ""

# Vite automatically loads .env and .env.local
# envalid validates on startup
cd frontend
bun run dev
```

---

## üìä Workflow Comparison

### Before (Broken)

```typescript
// Frontend scans for ANY backend
const ports = [4000, 4001, 4002, 4003];
for (const port of ports) {
  try {
    await fetch(`http://localhost:${port}/health`);
    return `http://localhost:${port}`; // ‚ùå WRONG!
  } catch {}
}
```

### After (Type-Safe)

```typescript
// Validated at startup, type-safe
import { VITE_BACKEND_BASE_URL } from './env';

export function getBackendUrl(): string {
  return VITE_BACKEND_BASE_URL; // ‚úÖ ALWAYS CORRECT
}

// If VITE_BACKEND_BASE_URL is missing or invalid,
// app won't start - fail fast with helpful error
```

---

## ‚úÖ Benefits Summary

### Type Safety
- ‚úÖ Validated at startup (fail fast)
- ‚úÖ Type-safe access (no stringly-typed config)
- ‚úÖ Helpful error messages

### Security
- ‚úÖ Secrets encrypted with dotenvx
- ‚úÖ .env.vault safe to commit
- ‚úÖ .env.local gitignored

### Developer Experience
- ‚úÖ Discoverable (`cat .env.local`)
- ‚úÖ Persists across sessions
- ‚úÖ Standard tooling (everyone knows .env)
- ‚úÖ Works with Vite HMR

### Production Ready
- ‚úÖ CI/CD with encrypted vault
- ‚úÖ Multi-environment support
- ‚úÖ No runtime surprises

---

## üéØ Migration Checklist

### Setup (30 min)

- [ ] Install dependencies
  ```bash
  cd backend && bun add dotenv envalid
  cd frontend && bun add envalid
  ```

- [ ] Create .env files
  ```bash
  # .env (committed)
  # .env.example (committed)
  # .env.local (gitignored - auto-generated)
  ```

- [ ] Update .gitignore
  ```bash
  echo ".env.local" >> .gitignore
  echo ".env.keys" >> .gitignore
  echo ".env*.local" >> .gitignore
  ```

### Backend (30 min)

- [ ] Create `backend/src/config/env.ts`
- [ ] Add envalid validation
- [ ] Update imports to use validated env
- [ ] Test: `cd backend && bun run dev`

### Frontend (20 min)

- [ ] Create `frontend/src/lib/env.ts`
- [ ] Add envalid validation
- [ ] Update `getEncoreClient.ts`
- [ ] Test: `cd frontend && bun run dev`

### Scripts (20 min)

- [ ] Update `port-coordinator.mjs` to generate `.env.local`
- [ ] Update `start-backend.sh` (remove manual exports)
- [ ] Update `start-frontend.sh` (remove manual exports)
- [ ] Test on worktree

### Testing (30 min)

- [ ] Test main tree
  ```bash
  cd ~/ScreenGraph
  ./scripts/start-backend.sh
  ./scripts/start-frontend.sh
  # Should use 4000/5173
  ```

- [ ] Test worktree
  ```bash
  cd ~/ScreenGraph-worktrees/Px8w6
  bun ../ScreenGraph/scripts/port-coordinator.mjs
  ./scripts/start-backend.sh
  ./scripts/start-frontend.sh
  # Should use 4008/5181
  ```

- [ ] Run `@test-default-run`
  ```bash
  # Should pass with correct backend connection
  ```

### Documentation (20 min)

- [ ] Update CLAUDE.md
- [ ] Update migration plan
- [ ] Document .env structure
- [ ] Add troubleshooting guide

**Total Time**: ~2.5 hours

---

## üîç Troubleshooting

### Error: "Env var VITE_BACKEND_BASE_URL is required"

```bash
# Check if .env exists
cat .env

# For worktree, check .env.local
cat .env.local

# If missing, regenerate
bun ./scripts/port-coordinator.mjs
```

### Frontend connects to wrong backend

```bash
# Check what frontend is loading
cat .env.local

# Should show VITE_BACKEND_BASE_URL=http://localhost:4008

# Restart frontend to reload env
pkill -f "vite"
./scripts/start-frontend.sh
```

### Type errors on env.BACKEND_PORT

```typescript
// Make sure you're using validated env
import { env } from './config/env';

// NOT
import { env } from 'process'; // ‚ùå WRONG

// Correct
console.log(env.BACKEND_PORT); // number (validated)
```

---

## üìö References

- **dotenv**: https://github.com/motdotla/dotenv
- **dotenvx**: https://dotenvx.com/docs
- **envalid**: https://github.com/af/envalid
- **Vite env**: https://vitejs.dev/guide/env-and-mode.html

---

**Recommendation**: Implement this approach. It's production-ready, type-safe, and follows industry best practices.

