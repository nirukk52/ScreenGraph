{
  "name": "backend_vibe",
  "description": "Backend engineering vibe for Encore.ts API development, database operations, and service orchestration.",
  "version": "1.0",
  "extends": "base_vibe",
  "domain": "backend",
  "environment_boundaries": {
    "encore_test": {
      "purpose": "Isolated testing with ephemeral resources",
      "runtime": "isolated_encore_runtime",
      "database": "ephemeral_test_db",
      "pubsub": "isolated_topics_require_explicit_imports",
      "use_cases": [
        "Unit tests for endpoints and domain logic",
        "Integration tests with imported subscriptions",
        "Fast feedback during development",
        "CI/CD pipeline testing"
      ],
      "commands": [
        "cd backend && encore test",
        "cd backend && encore test path/to/test.ts"
      ],
      "critical_rules": [
        "PubSub subscriptions MUST be explicitly imported in test files",
        "Import statement: import \"../path/to/subscription\"",
        "Without import, jobs publish but workers never start (stays 'queued')",
        "Test database is ephemeral and isolated"
      ],
      "pros": [
        "Fast test execution",
        "Clean isolation between tests",
        "Type-safe with Encore validation",
        "No external dependencies (except integration tests)"
      ],
      "cons": [
        "Separate from encore run runtime",
        "PubSub requires explicit imports",
        "Not connected to real external services"
      ]
    },
    "encore_run": {
      "purpose": "Full stack development with all services and workers",
      "runtime": "complete_encore_application",
      "database": "local_persistent_db",
      "pubsub": "all_subscriptions_active_automatically",
      "use_cases": [
        "Local development with hot reload",
        "Manual API testing via dashboard or curl",
        "Debugging PubSub flows with real workers",
        "Integration with external services (Appium, devices)"
      ],
      "commands": [
        "cd backend && encore run",
        "bun run dev (via Turborepo harness)",
        "cd .cursor && task founder:servers:start"
      ],
      "services": {
        "backend": "http://localhost:4000",
        "dashboard": "http://localhost:9400"
      },
      "critical_rules": [
        "NOT for running tests (use encore test instead)",
        "All PubSub subscriptions active by default",
        "Use for manual testing and debugging",
        "Connected to external services (Appium, devices)"
      ],
      "pros": [
        "Full system running with hot reload",
        "Real-time logging and tracing",
        "Encore dashboard for API testing",
        "All workers and subscriptions active"
      ],
      "cons": [
        "Slower startup than encore test",
        "Requires external dependencies",
        "Not suitable for automated testing"
      ]
    }
  },
  "mcp_tools": [
    {
      "name": "encore-mcp",
      "purpose": "Live Encore.ts backend introspection and API testing",
      "when_to_use": [
        "Inspect current API endpoints and schemas",
        "Test API calls without manual curl",
        "Debug service configuration issues",
        "Verify endpoint behavior before frontend integration"
      ],
      "key_operations": [
        "encore-mcp.get_services (list all services)",
        "encore-mcp.get_metadata (full app metadata)",
        "encore-mcp.call_endpoint (test API calls)",
        "encore-mcp.get_traces (debugging request flows)"
      ],
      "common_tools": [
        {
          "name": "mcp_encore-mcp_get_services",
          "purpose": "Inspect services and endpoints",
          "use_case": "Understanding endpoint signatures before writing tests"
        },
        {
          "name": "mcp_encore-mcp_query_database",
          "purpose": "Query test database during debugging",
          "use_case": "Inspecting run status, events, or graph data"
        },
        {
          "name": "mcp_encore-mcp_get_traces",
          "purpose": "List and analyze request traces",
          "use_case": "Debugging slow tests or request flows"
        },
        {
          "name": "mcp_encore-mcp_get_pubsub",
          "purpose": "Inspect PubSub topics and subscriptions",
          "use_case": "Verifying subscription configuration"
        },
        {
          "name": "mcp_encore-mcp_get_databases",
          "purpose": "Get database schema and table structure",
          "use_case": "Writing queries or understanding relationships"
        }
      ]
    },
    {
      "name": "github",
      "purpose": "Repository operations and code review",
      "when_to_use": [
        "Review related PRs for context",
        "Check commit history for changes",
        "Search codebase for patterns"
      ]
    }
  ],
  "rules": [
    "Follow backend_coding_rules.mdc for Encore.ts patterns",
    "Use Encore MCP for live introspection (never mutate production state)",
    "ALWAYS use structured logging via encore.dev/log (NEVER console.log)",
    "Database queries must use typed results with SQLDatabase",
    "After API changes, run: task founder:workflows:regen-client",
    "Use explicit literal unions (NOT indexed access types for Encore parser)",
    "Every function/class/type must have purpose comment"
  ],
  "documentation": [
    ".cursor/rules/backend_coding_rules.mdc",
    "backend/CLAUDE.md",
    "BACKEND_HANDOFF.md"
  ],
  "testing_patterns": {
    "unit_test": {
      "description": "Test single endpoint or function in isolation",
      "environment": "encore_test",
      "requires_imports": false,
      "example": "backend/run/start.test.ts"
    },
    "integration_test_database": {
      "description": "Test endpoint with database interaction",
      "environment": "encore_test",
      "requires_imports": false,
      "example": "backend/agent/persistence/run-db.repo.test.ts"
    },
    "integration_test_pubsub": {
      "description": "Test PubSub flow with worker subscription",
      "environment": "encore_test",
      "requires_imports": true,
      "import_statement": "import \"../orchestrator/subscription\"",
      "example": "backend/agent/tests/metrics.test.ts"
    },
    "metrics_test": {
      "description": "Validate agent metrics against deterministic expectations",
      "environment": "encore_test",
      "requires_imports": true,
      "requires_external": {
        "appium": "Start manually via Appium Inspector (not automated)",
        "android_device": "Start manually via Android Studio (not automated)",
        "note": "Task command checks prerequisites but does NOT auto-start services"
      },
      "command": "cd .cursor && task backend:integration:metrics",
      "example": "backend/agent/tests/metrics.test.ts"
    }
  },
  "task_commands": [
    {
      "command": "task backend:dev",
      "when": "Start backend service only"
    },
    {
      "command": "task backend:health",
      "when": "Check if backend is responding"
    },
    {
      "command": "task backend:test",
      "when": "Run backend unit tests"
    },
    {
      "command": "task backend:db:migrate",
      "when": "Run database migrations"
    },
    {
      "command": "task backend:db:shell",
      "when": "Open database shell for queries"
    },
    {
      "command": "task backend:logs",
      "when": "View backend service logs"
    },
    {
      "command": "task qa:smoke:backend",
      "when": "Run backend smoke tests"
    },
    {
      "command": "task founder:workflows:regen-client",
      "when": "Regenerate frontend client after API changes"
    },
    {
      "command": "task founder:workflows:db-reset",
      "when": "Reset database (DESTRUCTIVE)"
    },
    {
      "command": "task backend:integration:metrics",
      "when": "Run metrics integration test with Appium prerequisites",
      "prerequisites": [
        "Start Appium manually via Appium Inspector",
        "Start Android emulator via Android Studio",
        "Ensure backend is healthy (task checks this)",
        "Task verifies ADB, device, Appium, backend health before running test"
      ]
    },
    {
      "command": "encore test path/to/test.ts",
      "directory": "backend",
      "when": "Execute focused Encore test file"
    },
    {
      "command": "bun test:watch",
      "directory": "backend",
      "when": "Watch backend Vitest suite for rapid feedback"
    },
    {
      "command": "encore run",
      "directory": "backend",
      "when": "Manually run backend runtime outside automation harness"
    }
  ],
  "claude_skills": [
    {
      "skill": "backend-debugging",
      "when": "Systematic 10-phase debugging for Encore.ts issues",
      "type": "knowledge"
    },
    {
      "skill": "backend-testing",
      "when": "Testing patterns covering Encore.ts database and PubSub flows",
      "type": "knowledge"
    },
    {
      "skill": "backend-development",
      "when": "Encore.ts development patterns covering testing, polling, and database verification",
      "type": "knowledge"
    }
  ],
  "workflow_patterns": {
    "api_development": [
      "1. Search Graphiti for existing patterns",
      "2. Define types and DTOs (no 'any' types)",
      "3. Implement endpoint with typed request/response",
      "4. Add structured logging with context",
      "5. Test via encore-mcp.call_endpoint",
      "6. Run task founder:workflows:regen-client",
      "7. Document via Graphiti if new pattern"
    ],
    "database_changes": [
      "1. Create migration in backend/db/migrations/",
      "2. Run task backend:db:migrate",
      "3. Update repository with typed queries",
      "4. Test queries via task backend:db:shell",
      "5. Document schema changes in BACKEND_HANDOFF.md"
    ],
    "debugging_issues": [
      "1. Load @backend-debugging skill (10-phase process)",
      "2. Use encore-mcp.get_traces for request tracing",
      "3. Check logs via task backend:logs",
      "4. Use sequential-thinking for systematic analysis",
      "5. Document solution in Graphiti for future reference"
    ]
  },
  "default_timeouts": {
    "unit_test": "10s",
    "integration_test_database": "30s",
    "integration_test_pubsub": "60s",
    "metrics_test": "5min",
    "all_commands": "30s"
  },
  "common_pitfalls": [
    "❌ Using indexed access types: (typeof ARRAY)[number]",
    "✅ Use explicit literal unions instead",
    "❌ Using console.log for logging",
    "✅ Use encore.dev/log with structured context",
    "❌ Untyped database queries",
    "✅ Always specify generic type: db.query<ResultType>",
    "❌ Magic strings for status/enums",
    "✅ Use literal unions or const objects"
  ],
  "critical_patterns": {
    "pubsub_in_tests": {
      "rule": "ALWAYS import subscription at top of test file for PubSub tests",
      "import_statement": "import \"../orchestrator/subscription\"",
      "reason": "encore test only loads subscriptions that are imported",
      "without_import": "Jobs will publish but never be consumed (stays 'queued')"
    },
    "metrics_validation": {
      "rule": "Assert both event metrics AND database state",
      "reason": "Ensures consistency between reported metrics and actual data",
      "example": "backend/agent/tests/metrics.test.ts"
    },
    "environment_variables": {
      "rule": "Use env vars for test configuration and expectations",
      "config_file": "backend/config/env.ts",
      "example": "EXPECTED_UNIQUE_SCREENS_DISCOVERED"
    },
    "structured_logging": {
      "rule": "Use encore.dev/log with required fields: module, actor, runId",
      "never": "console.log (prohibited by founder rules)"
    }
  }
}

