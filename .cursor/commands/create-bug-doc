#!/bin/bash

# Create Bug Folder
# Usage: When @-mentioned in Cursor, this command sets up a new bug folder

# Get the bug ID and title from user input
read -p "Bug ID (e.g., BUG-003): " BUG_ID
read -p "Short Title (kebab-case, e.g., api-timeout-error): " TITLE

# Validate inputs
if [ -z "$BUG_ID" ] || [ -z "$TITLE" ]; then
    echo "‚ùå Error: Both Bug ID and Title are required"
    exit 1
fi

# Create folder name
FOLDER_NAME="${BUG_ID}-${TITLE}"
FOLDER_PATH="jira/bugs/${FOLDER_NAME}"

# Check if folder already exists
if [ -d "$FOLDER_PATH" ]; then
    echo "‚ùå Error: Folder ${FOLDER_PATH} already exists"
    exit 1
fi

# Create the folder
mkdir -p "$FOLDER_PATH"

# Copy templates and rename them
cp jira/bugs/TEMPLATE-main.md "${FOLDER_PATH}/${BUG_ID}-main.md"
cp jira/bugs/TEMPLATE-retro.md "${FOLDER_PATH}/${BUG_ID}-retro.md"
cp jira/bugs/TEMPLATE-status.md "${FOLDER_PATH}/${BUG_ID}-status.md"

# Replace placeholders in the main file
sed -i.bak "s/BUG-XXX/${BUG_ID}/g" "${FOLDER_PATH}/${BUG_ID}-main.md"
sed -i.bak "s/\[Short Title\]/${TITLE}/g" "${FOLDER_PATH}/${BUG_ID}-main.md"
rm "${FOLDER_PATH}/${BUG_ID}-main.md.bak"

# Replace placeholders in retro
sed -i.bak "s/BUG-XXX/${BUG_ID}/g" "${FOLDER_PATH}/${BUG_ID}-retro.md"
sed -i.bak "s/\[Short Title\]/${TITLE}/g" "${FOLDER_PATH}/${BUG_ID}-retro.md"
rm "${FOLDER_PATH}/${BUG_ID}-retro.md.bak"

# Replace placeholders in status
sed -i.bak "s/BUG-XXX/${BUG_ID}/g" "${FOLDER_PATH}/${BUG_ID}-status.md"
sed -i.bak "s/\[Short Title\]/${TITLE}/g" "${FOLDER_PATH}/${BUG_ID}-status.md"
rm "${FOLDER_PATH}/${BUG_ID}-status.md.bak"

echo "‚úÖ Bug folder created: ${FOLDER_PATH}"
echo ""
echo "üìÅ Created files:"
echo "   - ${BUG_ID}-main.md (main ticket)"
echo "   - ${BUG_ID}-retro.md (retrospective)"
echo "   - ${BUG_ID}-status.md (status report)"
echo ""
echo "üöÄ Next steps:"
echo "   1. Fill out ${BUG_ID}-main.md with bug details"
echo "   2. Update ${BUG_ID}-status.md during investigation/fix"
echo "   3. Complete ${BUG_ID}-retro.md after fix is deployed"

