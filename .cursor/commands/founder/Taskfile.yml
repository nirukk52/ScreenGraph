version: '3'

# Founder commands
# High-level orchestration, project management, workflows

vars:
  BACKEND_PORT:
    sh: node ../../../automation/scripts/env.mjs backend-port
  FRONTEND_PORT:
    sh: node ../../../automation/scripts/env.mjs frontend-port
  WORKTREE_NAME:
    sh: node ../../../automation/scripts/env.mjs worktree-name

tasks:
  # Server management
  servers:start:
    desc: "Start backend and frontend services with health checks"
    cmds:
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸš€ Starting ScreenGraph Services"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - echo "ğŸ“ Worktree {{.WORKTREE_NAME}}"
      - echo "ğŸ”¢ Backend {{.BACKEND_PORT}} | Frontend {{.FRONTEND_PORT}}"
      - echo ""
      - echo "ğŸ“¦ Installing dependencies..."
      - cd ../../backend && bun install > /dev/null 2>&1 || bun install
      - cd ../../frontend && bun install > /dev/null 2>&1 || bun install
      - echo "   âœ“ Dependencies installed"
      - echo ""
      - echo "ğŸ§¹ Stopping existing services..."
      - pkill -f "encore run" 2>/dev/null || true
      - pkill -f "vite dev" 2>/dev/null || true
      - lsof -ti:{{.BACKEND_PORT}} 2>/dev/null | xargs kill -9 2>/dev/null || true
      - lsof -ti:{{.FRONTEND_PORT}} 2>/dev/null | xargs kill -9 2>/dev/null || true
      - sleep 2
      - echo "   âœ“ Ports cleared"
      - echo ""
      - echo "ğŸš€ Starting backend..."
      - mkdir -p ../../.logs
      - cd ../../backend && nohup encore run > ../.logs/backend-{{.WORKTREE_NAME}}.log 2>&1 &
      - echo "   â³ Waiting for backend to be ready..."
      - |
        for i in {1..30}; do
          if curl -s http://localhost:{{.BACKEND_PORT}}/ >/dev/null 2>&1; then
            echo "   âœ… Backend ready (port {{.BACKEND_PORT}})"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "   âŒ Backend failed to start (timeout)"
            echo "      Check logs: tail -f .logs/backend-{{.WORKTREE_NAME}}.log"
            exit 1
          fi
          sleep 1
        done
      - echo ""
      - echo "ğŸš€ Starting frontend..."
      - cd ../../frontend && nohup bunx --bun vite dev --port {{.FRONTEND_PORT}} --host > ../.logs/frontend-{{.WORKTREE_NAME}}.log 2>&1 &
      - echo "   â³ Waiting for frontend to be ready..."
      - |
        for i in {1..30}; do
          if curl -s http://localhost:{{.FRONTEND_PORT}}/ >/dev/null 2>&1; then
            echo "   âœ… Frontend ready (port {{.FRONTEND_PORT}})"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "   âš ï¸  Frontend may not be ready (timeout)"
            echo "      Check logs: tail -f .logs/frontend-{{.WORKTREE_NAME}}.log"
          fi
          sleep 1
        done
      - sleep 2
      - echo ""
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "âœ… Services Running"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - node ../../../automation/scripts/env.mjs status
      - echo ""
      - echo "   ğŸ“Š URLs:"
      - echo "      Backend    - http://localhost:{{.BACKEND_PORT}}"
      - echo "      Frontend   - http://localhost:{{.FRONTEND_PORT}}"
      - echo "      Dashboard  - http://localhost:9400"
      - echo ""
      - echo "   ğŸ“ Logs:"
      - echo "      Backend    - tail -f .logs/backend-{{.WORKTREE_NAME}}.log"
      - echo "      Frontend   - tail -f .logs/frontend-{{.WORKTREE_NAME}}.log"
      - echo ""
      - echo "   ğŸ›‘ Stop:"
      - echo "      task founder:servers:stop"
      - echo ""
    silent: false

  servers:stop:
    desc: "Stop all services"
    cmds:
      - echo "ğŸ›‘ Stopping services..."
      - pkill -f "encore run" || true
      - pkill -f "vite dev" || true
      - sleep 1
      - echo "âœ… Services stopped"
    silent: false

  servers:restart:
    desc: "Restart all services"
    cmds:
      - task: servers:stop
      - sleep 2
      - task: servers:start
    silent: false

  servers:status:
    desc: "Check service status"
    cmds:
      - node ../../../automation/scripts/env.mjs status
    silent: false

  # Rules and validation
  rules:check:
    desc: "Validate all founder rules"
    cmds:
      - node ../../../automation/scripts/check-founder-rules.mjs
    silent: false

  # Workflows
  workflows:regen-client:
    desc: "Regenerate frontend Encore client"
    cmds:
      - echo "ğŸ”„ Regenerating Encore client..."
      - cd ../../frontend && bun run gen
      - echo "âœ… Client regenerated"
    silent: false

  workflows:db-reset:
    desc: "Reset database (DESTRUCTIVE)"
    prompt: "This will delete all data. Continue?"
    cmds:
      - echo "âš ï¸  Resetting database..."
      - cd ../../backend && encore db reset
      - echo "âœ… Database reset complete"
    silent: false

  # Testing
  testing:smoke:
    desc: "Run all smoke tests"
    cmds:
      - task: qa:smoke:backend
      - task: qa:smoke:frontend
    silent: false

  testing:backend:
    desc: "Run backend tests"
    cmds:
      - echo "ğŸ§ª Running backend tests..."
      - cd ../../backend && encore test
    silent: false

  testing:frontend:
    desc: "Run frontend tests"
    cmds:
      - echo "ğŸ§ª Running frontend tests..."
      - cd ../../frontend && bun test
    silent: false
