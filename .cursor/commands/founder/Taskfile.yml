version: '3'

# Founder commands
# High-level orchestration, project management, workflows

vars:
  BACKEND_PORT:
    sh: node ../../../automation/scripts/env.mjs backend-port
  FRONTEND_PORT:
    sh: node ../../../automation/scripts/env.mjs frontend-port

tasks:
  # Server management
  servers:start:
    desc: "Start backend and frontend services via Turborepo harness"
    cmds:
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸš€ Starting ScreenGraph Turborepo Harness"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - echo "ğŸ”¢ Backend {{.BACKEND_PORT}} | Frontend {{.FRONTEND_PORT}} (from .env)"
      - echo ""
      - echo "ğŸ“¦ Ensuring root harness dependencies (bun install)"
      - bun install > /dev/null 2>&1 || bun install
      - echo "ğŸ“¦ Ensuring backend workspace dependencies"
      - cd ../../backend && bun install > /dev/null 2>&1 || bun install
      - echo "ğŸ“¦ Ensuring frontend workspace dependencies"
      - cd ../../frontend && bun install > /dev/null 2>&1 || bun install
      - echo ""
      - echo "ğŸ§¹ Clearing lingering dev servers..."
      - pkill -f "turbo run dev" 2>/dev/null || true
      - pkill -f "encore run" 2>/dev/null || true
      - pkill -f "vite dev" 2>/dev/null || true
      - sleep 1
      - echo ""
      - echo "ğŸš€ Launching Turborepo dev harness (Ctrl+C to stop)"
      - bun run dev
    silent: false

  servers:stop:
    desc: "Stop all services"
    cmds:
      - echo "ğŸ›‘ Stopping Turborepo harness..."
      - pkill -f "turbo run dev" || true
      - pkill -f "encore run" || true
      - pkill -f "vite dev" || true
      - sleep 1
      - echo "âœ… Services stopped"
    silent: false

  servers:restart:
    desc: "Restart all services"
    cmds:
      - task: servers:stop
      - sleep 2
      - task: servers:start
    silent: false

  servers:status:
    desc: "Check service status"
    cmds:
      - node ../../../automation/scripts/env.mjs status
    silent: false

  # Rules and validation
  rules:check:
    desc: "Validate all founder rules"
    cmds:
      - node ../../../automation/scripts/check-founder-rules.mjs
    silent: false

  # Workflows
  workflows:regen-client:
    desc: "Regenerate frontend Encore client"
    cmds:
      - echo "ğŸ”„ Regenerating Encore client..."
      - cd ../../frontend && bun run gen
      - echo "âœ… Client regenerated"
    silent: false

  workflows:db-reset:
    desc: "Reset database (DESTRUCTIVE)"
    prompt: "This will delete all data. Continue?"
    cmds:
      - echo "âš ï¸  Resetting database..."
      - cd ../../backend && encore db reset
      - echo "âœ… Database reset complete"
    silent: false

  # Testing
  testing:smoke:
    desc: "Run all smoke tests"
    cmds:
      - task: qa:smoke:backend
      - task: qa:smoke:frontend
    silent: false

  testing:backend:
    desc: "Run backend tests"
    cmds:
      - echo "ğŸ§ª Running backend tests..."
      - cd ../../backend && encore test
    silent: false

  testing:frontend:
    desc: "Run frontend tests"
    cmds:
      - echo "ğŸ§ª Running frontend tests..."
      - cd ../../frontend && bun test
    silent: false
