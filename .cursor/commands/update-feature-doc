#!/bin/bash

# Update Feature Documentation
# Usage: When @-mentioned in Cursor, this command adds a handoff entry to an existing feature folder

# List all feature folders
FEATURE_FOLDERS=(jira/feature-requests/FR-*)

# Check if any feature folders exist
if [ ${#FEATURE_FOLDERS[@]} -eq 0 ] || [ ! -d "${FEATURE_FOLDERS[0]}" ]; then
    echo "‚ùå Error: No feature folders found in jira/feature-requests/"
    exit 1
fi

# Display available features
echo "Available features:"
echo ""
for i in "${!FEATURE_FOLDERS[@]}"; do
    FOLDER_NAME=$(basename "${FEATURE_FOLDERS[$i]}")
    echo "  [$i] $FOLDER_NAME"
done
echo ""

# Get user selection
read -p "Select feature number: " SELECTION

# Validate selection
if ! [[ "$SELECTION" =~ ^[0-9]+$ ]] || [ "$SELECTION" -ge "${#FEATURE_FOLDERS[@]}" ]; then
    echo "‚ùå Error: Invalid selection"
    exit 1
fi

# Get selected folder
SELECTED_FOLDER="${FEATURE_FOLDERS[$SELECTION]}"
FOLDER_NAME=$(basename "$SELECTED_FOLDER")
HANDOFF_FILE="$SELECTED_FOLDER/handoff.md"

# Extract FR ID and title from folder name
FEATURE_ID=$(echo "$FOLDER_NAME" | cut -d'-' -f1-2)
TITLE=$(echo "$FOLDER_NAME" | cut -d'-' -f3-)

# Check if handoff file exists
if [ ! -f "$HANDOFF_FILE" ]; then
    echo "üìù Creating new handoff file..."
    cp jira/feature-requests/TEMPLATE-handoff.md "$HANDOFF_FILE"
    sed -i.bak "s/FR-XXX/${FEATURE_ID}/g" "$HANDOFF_FILE"
    sed -i.bak "s/\[Short Title\]/${TITLE}/g" "$HANDOFF_FILE"
    rm "${HANDOFF_FILE}.bak"
    HANDOFF_NUM=1
else
    # Count existing handoff entries
    HANDOFF_NUM=$(($(grep -c "^## Handoff #" "$HANDOFF_FILE") + 1))
fi

# Get current date
CURRENT_DATE=$(date +"%Y-%m-%d")

echo ""
echo "Adding Handoff #${HANDOFF_NUM} to ${FEATURE_ID}"
echo ""

# Get handoff details
read -p "What are you doing? " WHAT_DOING
read -p "What is pending? (comma-separated) " PENDING
read -p "What do you plan to do next? " NEXT_STEPS
read -p "Modules you are touching? (comma-separated paths) " MODULES
read -p "Work status rating (0-5): " RATING
read -p "Notes for next agent: " NOTES

# Convert comma-separated values to markdown lists
PENDING_LIST=""
IFS=',' read -ra PENDING_ITEMS <<< "$PENDING"
for item in "${PENDING_ITEMS[@]}"; do
    PENDING_LIST="${PENDING_LIST}- [ ] $(echo $item | xargs)\n"
done

MODULES_LIST=""
IFS=',' read -ra MODULE_ITEMS <<< "$MODULES"
for item in "${MODULE_ITEMS[@]}"; do
    MODULES_LIST="${MODULES_LIST}- \`$(echo $item | xargs)\`\n"
done

# Append new handoff entry
cat >> "$HANDOFF_FILE" << EOF

## Handoff #${HANDOFF_NUM} - ${CURRENT_DATE}

### What I am doing
${WHAT_DOING}

### What is pending
$(echo -e "$PENDING_LIST")
### What I plan to do next
${NEXT_STEPS}

### Modules I am touching
$(echo -e "$MODULES_LIST")
### Work status rating (out of 5)
${RATING}

### Notes for next agent
${NOTES}

---
EOF

echo ""
echo "‚úÖ Handoff entry added to: ${HANDOFF_FILE}"
echo "   Handoff #${HANDOFF_NUM} - ${CURRENT_DATE}"
echo ""
echo "üöÄ Next steps:"
echo "   1. Review the handoff entry in ${HANDOFF_FILE}"
echo "   2. Update ${FEATURE_ID}-status.md if needed"
echo "   3. Run @update-handoff when ready to commit"


