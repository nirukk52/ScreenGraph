version: '3'

# QA commands
# Consolidated testing and quality assurance tasks

tasks:
  # Smoke tests (parallel health checks)
  smoke:
    desc: "Health checks for all services"
    cmds:
      - echo "ðŸ§ª Running smoke tests..."
      - |
        BACKEND_FAIL=0
        FRONTEND_FAIL=0
        
        curl -sf http://localhost:${BACKEND_PORT:-4000}/health > /dev/null && echo "âœ… Backend healthy" || { echo "âŒ Backend smoke test failed"; BACKEND_FAIL=1; } &
        PID_BACKEND=$!
        
        curl -sf http://localhost:${FRONTEND_PORT:-5173} > /dev/null && echo "âœ… Frontend healthy" || { echo "âŒ Frontend smoke test failed"; FRONTEND_FAIL=1; } &
        PID_FRONTEND=$!
        
        wait $PID_BACKEND || BACKEND_FAIL=1
        wait $PID_FRONTEND || FRONTEND_FAIL=1
        
        if [ $BACKEND_FAIL -eq 0 ] && [ $FRONTEND_FAIL -eq 0 ]; then
          echo "âœ… All smoke tests passed"
          exit 0
        else
          echo "âŒ Some smoke tests failed"
          exit 1
        fi
    silent: false

  smoke:backend:
    desc: "Backend health check only"
    cmds:
      - echo "ðŸ§ª Testing backend health..."
      - curl -f http://localhost:${BACKEND_PORT:-4000}/health || (echo "âŒ Backend smoke test failed" && exit 1)
      - echo "âœ… Backend smoke test passed"
    silent: false

  smoke:frontend:
    desc: "Frontend availability check only"
    cmds:
      - echo "ðŸ§ª Testing frontend availability..."
      - curl -f http://localhost:${FRONTEND_PORT:-5173} > /dev/null || (echo "âŒ Frontend smoke test failed" && exit 1)
      - echo "âœ… Frontend smoke test passed"
    silent: false

  # Static analysis
  lint:
    desc: "Lint both services"
    cmds:
      - echo "ðŸ” Linting backend..."
      - cd ../../../backend && bunx biome lint .
      - echo "ðŸ” Linting frontend..."
      - cd ../../../frontend && bunx biome lint .
      - echo "âœ… Linting complete"
    silent: false

  typecheck:
    desc: "TypeScript checking for both services"
    cmds:
      - echo "ðŸ” Type checking frontend..."
      - cd ../../../frontend && bun run check
      - echo "âœ… Frontend types valid"
    silent: false

  # Unit tests
  unit:backend:
    desc: "Backend unit tests"
    cmds:
      - echo "ðŸ§ª Running backend unit tests..."
      - cd ../../../backend && encore test
    silent: false

  unit:frontend:
    desc: "Frontend unit tests"
    cmds:
      - echo "âš ï¸  No frontend unit tests configured yet"
      - echo "   Frontend uses Playwright for E2E tests (use qa:e2e)"
    silent: false

  unit:
    desc: "All unit tests (backend only, frontend has no unit tests)"
    cmds:
      - task: unit:backend
      - echo "Note - Frontend has no unit tests (uses E2E tests instead)"
    silent: false

  # E2E tests
  e2e:
    desc: "Frontend E2E tests (headless)"
    cmds:
      - echo "ðŸ§ª Running E2E tests..."
      - cd ../../../frontend && bun run test:e2e
    silent: false

  e2e:headed:
    desc: "Frontend E2E tests (headed mode)"
    cmds:
      - echo "ðŸ§ª Running E2E tests (headed)..."
      - cd ../../../frontend && bun run test:e2e:headed
    silent: false

  e2e:ui:
    desc: "Playwright UI mode"
    cmds:
      - echo "ðŸŽ­ Opening Playwright UI..."
      - cd ../../../frontend && bun run test:e2e:ui
    silent: false

  # Complete test suite
  all:
    desc: "Complete test suite (smoke + lint + typecheck + unit + e2e)"
    cmds:
      - task: smoke
      - task: lint
      - task: typecheck
      - task: unit
      - task: e2e
      - echo "ðŸŽ‰ All tests passed!"
    silent: false

  # Appium (mobile testing)
  appium:start:
    desc: "Start Appium server"
    cmds:
      - echo "ðŸ“± Starting Appium server on port ${APPIUM_PORT:-4723}..."
      - echo "âš ï¸  Appium start not yet fully implemented"
      - echo "   Manual start - appium --port ${APPIUM_PORT:-4723}"
    silent: false

  appium:stop:
    desc: "Stop Appium server"
    cmds:
      - echo "ðŸ›‘ Stopping Appium server..."
      - lsof -ti:${APPIUM_PORT:-4723} 2>/dev/null | xargs kill -9 2>/dev/null || true
      - echo "âœ… Appium server stopped"
    silent: false
