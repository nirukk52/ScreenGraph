version: '3'

# QA commands
# Consolidated testing and quality assurance tasks

tasks:
  # Smoke tests (parallel health checks)
  smoke:
    desc: "Health checks for all services"
    cmds:
      - echo "ğŸ§ª Running smoke tests..."
      - |
        BACKEND_FAIL=0
        FRONTEND_FAIL=0
        
        curl -sf http://localhost:${BACKEND_PORT:-4000}/health > /dev/null && echo "âœ… Backend healthy" || { echo "âŒ Backend smoke test failed"; BACKEND_FAIL=1; } &
        PID_BACKEND=$!
        
        curl -sf http://localhost:${FRONTEND_PORT:-5173} > /dev/null && echo "âœ… Frontend healthy" || { echo "âŒ Frontend smoke test failed"; FRONTEND_FAIL=1; } &
        PID_FRONTEND=$!
        
        wait $PID_BACKEND || BACKEND_FAIL=1
        wait $PID_FRONTEND || FRONTEND_FAIL=1
        
        if [ $BACKEND_FAIL -eq 0 ] && [ $FRONTEND_FAIL -eq 0 ]; then
          echo "âœ… All smoke tests passed"
          exit 0
        else
          echo "âŒ Some smoke tests failed"
          exit 1
        fi
    silent: false

  smoke:backend:
    desc: "Backend health check only"
    cmds:
      - echo "ğŸ§ª Testing backend health..."
      - curl -f http://localhost:${BACKEND_PORT:-4000}/health || (echo "âŒ Backend smoke test failed" && exit 1)
      - echo "âœ… Backend smoke test passed"
    silent: false

  smoke:frontend:
    desc: "Frontend availability check only"
    cmds:
      - echo "ğŸ§ª Testing frontend availability..."
      - curl -f http://localhost:${FRONTEND_PORT:-5173} > /dev/null || (echo "âŒ Frontend smoke test failed" && exit 1)
      - echo "âœ… Frontend smoke test passed"
    silent: false

  # Static analysis
  lint:
    desc: "Lint both services"
    cmds:
      - echo "ğŸ” Linting backend..."
      - cd ../../../backend && bunx biome lint .
      - echo "ğŸ” Linting frontend..."
      - cd ../../../frontend && bunx biome lint .
      - echo "âœ… Linting complete"
    silent: false

  typecheck:
    desc: "TypeScript checking for both services"
    cmds:
      - echo "ğŸ” Type checking frontend..."
      - cd ../../../frontend && bun run check
      - echo "âœ… Frontend types valid"
    silent: false

  # Unit tests
  unit:backend:
    desc: "Backend unit tests"
    cmds:
      - echo "ğŸ§ª Running backend unit tests..."
      - cd ../../../backend && encore test
    silent: false

  unit:frontend:
    desc: "Frontend unit tests"
    cmds:
      - echo "âš ï¸  No frontend unit tests configured yet"
      - echo "   Frontend uses Playwright for E2E tests (use qa:e2e)"
    silent: false

  unit:
    desc: "All unit tests (backend only, frontend has no unit tests)"
    cmds:
      - task: unit:backend
      - echo "Note - Frontend has no unit tests (uses E2E tests instead)"
    silent: false

  # E2E tests
  e2e:
    desc: "Frontend E2E tests (headless)"
    cmds:
      - echo "ğŸ§ª Running E2E tests..."
      - cd ../../../frontend && bun run test:e2e
    silent: false

  e2e:headed:
    desc: "Frontend E2E tests (headed mode)"
    cmds:
      - echo "ğŸ§ª Running E2E tests (headed)..."
      - cd ../../../frontend && bun run test:e2e:headed
    silent: false

  e2e:ui:
    desc: "Playwright UI mode"
    cmds:
      - echo "ğŸ­ Opening Playwright UI..."
      - cd ../../../frontend && bun run test:e2e:ui
    silent: false

  # Validation-only QA suite (for git hooks and CI)
  # Does NOT modify code - only validates
  all:
    desc: "Validation QA suite (rules + smoke + lint + typecheck + unit + e2e)"
    cmds:
      - echo "ğŸ¯ Running validation QA suite (no auto-fix)..."
      - echo ""
      - task: rules:check
      - echo ""
      - task: smoke
      - echo ""
      - task: lint
      - echo ""
      - task: typecheck
      - echo ""
      - task: unit
      - echo ""
      - task: e2e
      - echo ""
      - echo "ğŸ‰ All validation checks passed!"
    silent: false
  
  # QA suite without E2E (for CI when BrowserStack credentials unavailable)
  all:no-e2e:
    desc: "Validation QA suite without E2E tests (rules + smoke + lint + typecheck + unit)"
    cmds:
      - echo "ğŸ¯ Running validation QA suite (no E2E, no auto-fix)..."
      - echo ""
      - task: rules:check
      - echo ""
      - task: smoke
      - echo ""
      - task: lint
      - echo ""
      - task: typecheck
      - echo ""
      - task: unit
      - echo ""
      - echo "â­ï¸  Skipping E2E tests (BrowserStack credentials not available)"
      - echo ""
      - echo "ğŸ‰ All validation checks passed!"
    silent: false
  
  # Complete QA workflow (fix THEN validate)
  # Use this manually before committing
  all:fix:
    desc: "Complete workflow - auto-fix then validate (manual use only)"
    cmds:
      - echo "Step 1 - Auto-fixing issues..."
      - task: fix
      - echo ""
      - echo "Auto-fix complete. Review changes with git diff"
      - echo "Stage changes with git add . if satisfied"
      - echo ""
      - echo "Step 2 - Running validation suite..."
      - task: all
    silent: false

  # Appium (mobile testing)
  appium:start:
    desc: "Start Appium server"
    cmds:
      - echo "ğŸ“± Starting Appium server on port ${APPIUM_PORT:-4723}..."
      - echo "âš ï¸  Appium start not yet fully implemented"
      - echo "   Manual start - appium --port ${APPIUM_PORT:-4723}"
    silent: false

  appium:stop:
    desc: "Stop Appium server gracefully"
    cmds:
      - bash ../../../automation/scripts/appium-stop.sh
    silent: false

  # Rules validation
  rules:check:
    desc: "Validate all founder rules"
    cmds:
      - node ../../../automation/scripts/check-founder-rules.mjs
    silent: false

  # Auto-fix code quality issues
  fix:
    desc: "Auto-fix linting and formatting issues"
    cmds:
      - echo "ğŸ”§ Auto-fixing backend..."
      - cd ../../../backend && bunx biome check --write .
      - echo "ğŸ”§ Auto-fixing frontend..."
      - cd ../../../frontend && bunx biome check --write .
      - echo "âœ… Auto-fix complete"
    silent: false
