#!/usr/bin/env bash
# Update Handoff Command - Item-Level Handoffs Only
#
# Updates handoff.md for a specific feature, bug, tech debt, or chore item.
# All work must be tracked through jira/ items - no global handoffs.

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Constants
JIRA_DIR="jira"
MAX_HANDOFF_LINES=50

# Helper functions
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1" >&2; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }

show_help() {
  cat <<EOF
Usage: update-handoff [OPTIONS] [ITEM-ID]

Update handoff.md for a specific feature, bug, tech debt, or chore item.

EXAMPLES:
  update-handoff FR-015          # Update feature request #15
  update-handoff BUG-003         # Update bug #3
  update-handoff TD-007          # Update tech debt #7
  update-handoff CHORE-001       # Update chore #1
  update-handoff                 # Interactive: list all items

OPTIONS:
  -h, --help       Show this help message
  -l, --list       List all available items
  -n, --dry-run    Show what would be updated without writing

REQUIRED FILES:
  Every item must have handoff.md, main.md, and status.md

LINE LIMITS:
  handoff.md: ≤ ${MAX_HANDOFF_LINES} lines (enforced)

HANDOFF CHAIN:
  Each handoff links to the NEXT item in the backlog, creating a
  narrative of progress across features, bugs, debt, and chores.

For more info: .cursor/DETERMINISTIC_CURSOR_PLAN.md
EOF
}

list_all_items() {
  print_info "Available items in ${JIRA_DIR}/:"
  echo ""
  
  for category in feature-requests bugs tech-debt chores; do
    local dir="${JIRA_DIR}/${category}"
    if [[ -d "$dir" ]]; then
      echo -e "${BLUE}${category}${NC}:"
      find "$dir" -maxdepth 1 -type d -name "*-*" | sort | while read -r item_dir; do
        local item_id=$(basename "$item_dir")
        local has_handoff="❌"
        [[ -f "$item_dir/handoff.md" ]] && has_handoff="✓"
        echo "  ${has_handoff} ${item_id}"
      done
      echo ""
    fi
  done
}

find_item_path() {
  local item_id="$1"
  
  # Extract prefix and number
  local prefix="${item_id%%-*}"
  local number="${item_id##*-}"
  
  # Map prefix to category
  local category=""
  case "$prefix" in
    FR) category="feature-requests" ;;
    BUG) category="bugs" ;;
    TD) category="tech-debt" ;;
    CHORE) category="chores" ;;
    *)
      print_error "Invalid item ID format: ${item_id}"
      print_error "Expected: FR-XXX, BUG-XXX, TD-XXX, or CHORE-XXX"
      return 1
      ;;
  esac
  
  # Find matching directory
  local item_dir="${JIRA_DIR}/${category}/${item_id}"
  
  # Try with wildcard suffix
  if [[ ! -d "$item_dir" ]]; then
    local matches=( "${JIRA_DIR}/${category}/${item_id}"-* )
    if [[ -d "${matches[0]}" ]]; then
      item_dir="${matches[0]}"
    else
      print_error "Item not found: ${item_id}"
      print_info "Run 'create-feature/bug/techdebt/chore' first"
      return 1
    fi
  fi
  
  echo "$item_dir"
}

get_next_handoff_number() {
  local handoff_file="$1"
  
  if [[ ! -f "$handoff_file" ]]; then
    echo "1"
    return
  fi
  
  local last_num=$(grep -o "## Handoff #[0-9]\+" "$handoff_file" | tail -1 | grep -o "[0-9]\+")
  if [[ -z "$last_num" ]]; then
    echo "1"
  else
    echo $((last_num + 1))
  fi
}

update_handoff_interactive() {
  local item_dir="$1"
  local item_id=$(basename "$item_dir")
  local handoff_file="${item_dir}/handoff.md"
  
  print_info "Updating handoff for: ${item_id}"
  echo ""
  
  # Get handoff number
  local handoff_num=$(get_next_handoff_number "$handoff_file")
  
  # Prompt for information
  echo -e "${BLUE}What are you doing?${NC} (Brief, 1-2 lines)"
  read -r what_doing
  
  echo -e "${BLUE}What is pending?${NC} (Comma-separated list)"
  read -r pending_items
  
  echo -e "${BLUE}What's next?${NC} (Comma-separated next steps)"
  read -r next_steps
  
  echo -e "${BLUE}Modules touched?${NC} (Comma-separated file paths)"
  read -r modules
  
  echo -e "${BLUE}Work rating (0-5)?${NC}"
  read -r rating
  
  echo -e "${BLUE}Next item ID?${NC} (e.g., FR-019, BUG-004, or 'TBD')"
  read -r next_id
  
  echo -e "${BLUE}Related items?${NC} (Comma-separated IDs, or leave empty)"
  read -r related_ids
  
  echo -e "${BLUE}Notes for next agent?${NC} (Optional, can be multi-line. Press Ctrl+D when done)"
  notes=$(cat)
  
  # Create handoff entry
  local date=$(date +%Y-%m-%d)
  local handoff_entry=""
  
  handoff_entry+="## Handoff #${handoff_num} — ${date}\n\n"
  handoff_entry+="### What I am doing\n"
  handoff_entry+="${what_doing}\n\n"
  
  handoff_entry+="### What is pending\n"
  IFS=',' read -ra PENDING <<< "$pending_items"
  for item in "${PENDING[@]}"; do
    handoff_entry+="- [ ] $(echo "$item" | xargs)\n"
  done
  handoff_entry+="\n"
  
  handoff_entry+="### What I plan to do next\n"
  IFS=',' read -ra NEXTS <<< "$next_steps"
  for item in "${NEXTS[@]}"; do
    handoff_entry+="- $(echo "$item" | xargs)\n"
  done
  handoff_entry+="\n"
  
  handoff_entry+="### Modules I am touching\n"
  IFS=',' read -ra MODS <<< "$modules"
  for mod in "${MODS[@]}"; do
    handoff_entry+="- \`$(echo "$mod" | xargs)\`\n"
  done
  handoff_entry+="\n"
  
  handoff_entry+="### Work status rating (out of 5)\n"
  handoff_entry+="${rating}\n\n"
  
  handoff_entry+="### Handoff Chain\n"
  handoff_entry+="**Next Item:** ${next_id}\n"
  if [[ -n "$related_ids" ]]; then
    handoff_entry+="**Related:** ${related_ids}\n"
  fi
  handoff_entry+="\n"
  
  if [[ -n "$notes" ]]; then
    handoff_entry+="### Notes for next agent\n"
    handoff_entry+="${notes}\n\n"
  fi
  
  handoff_entry+="---\n\n"
  
  # Create or append to handoff file
  if [[ ! -f "$handoff_file" ]]; then
    echo -e "# Handoff Log - ${item_id}\n\n" > "$handoff_file"
  fi
  
  # Append new handoff
  echo -e "$handoff_entry" >> "$handoff_file"
  
  # Check line limit
  local line_count=$(wc -l < "$handoff_file")
  if (( line_count > MAX_HANDOFF_LINES )); then
    print_warning "Handoff file exceeds ${MAX_HANDOFF_LINES} lines (current: ${line_count})"
    print_warning "Consider creating a new item or archiving old handoffs"
  else
    print_success "Handoff #${handoff_num} added (${line_count}/${MAX_HANDOFF_LINES} lines)"
  fi
  
  # Update status.md with timestamp
  local status_file="${item_dir}/status.md"
  if [[ -f "$status_file" ]]; then
    # Update "Last Updated" line
    if grep -q "Last Updated:" "$status_file"; then
      sed -i.bak "s/Last Updated:.*/Last Updated: ${date}/" "$status_file" && rm "${status_file}.bak"
      print_success "Updated status.md timestamp"
    fi
  fi
  
  print_success "Handoff updated successfully!"
  print_info "File: ${handoff_file}"
}

# Main logic
DRY_RUN=false
ITEM_ID=""

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      exit 0
      ;;
    -l|--list)
      list_all_items
      exit 0
      ;;
    -n|--dry-run)
      DRY_RUN=true
      shift
      ;;
    *)
      ITEM_ID="$1"
      shift
      ;;
  esac
done

# If no item ID provided, list and prompt
if [[ -z "$ITEM_ID" ]]; then
  list_all_items
  echo -e "${BLUE}Enter item ID to update:${NC}"
  read -r ITEM_ID
fi

# Find item path
ITEM_PATH=$(find_item_path "$ITEM_ID")
if [[ $? -ne 0 ]]; then
  exit 1
fi

# Check required files exist
HANDOFF_FILE="${ITEM_PATH}/handoff.md"
MAIN_FILE="${ITEM_PATH}/main.md"
STATUS_FILE="${ITEM_PATH}/status.md"

if [[ ! -f "$MAIN_FILE" ]]; then
  print_error "Missing main.md in ${ITEM_PATH}"
  print_info "Run the appropriate create command first"
  exit 1
fi

if [[ ! -f "$STATUS_FILE" ]]; then
  print_error "Missing status.md in ${ITEM_PATH}"
  print_info "Run the appropriate create command first"
  exit 1
fi

# Dry run check
if [[ "$DRY_RUN" = true ]]; then
  print_info "DRY RUN: Would update handoff for ${ITEM_ID}"
  print_info "Path: ${ITEM_PATH}"
  exit 0
fi

# Update handoff interactively
update_handoff_interactive "$ITEM_PATH"

print_success "Done! Remember to commit your changes."

