#!/bin/bash
# Verify Worktree Setup
# 
# Purpose: Run this FIRST in any new worktree to verify correct setup
# 
# Lightweight Model:
# - Worktrees are for CODE EDITING only
# - Services run ONLY on main tree (default ports)
# - This command verifies you're in the right mode
# 
# Usage:
#   @verify-worktree-isolation in Cursor chat
#   or
#   .cursor/commands/verify-worktree-isolation

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸ” Worktree Setup Verification${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Change to repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$SCRIPT_DIR/../.."
cd "$REPO_ROOT"

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 1: Detect Worktree
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${BLUE}ğŸ“ Step 1: Detecting Worktree${NC}"
WORKTREE_NAME=$(basename $(git rev-parse --show-toplevel))
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo -e "   Location: ${GREEN}$WORKTREE_NAME${NC}"
echo -e "   Branch: ${GREEN}$BRANCH${NC}"
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 2: Determine Mode
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${BLUE}ğŸ¯ Step 2: Worktree Mode${NC}"

if [ "$WORKTREE_NAME" = "ScreenGraph" ]; then
    echo -e "${CYAN}ğŸ  MAIN TREE (Runtime Environment)${NC}"
    echo ""
    echo -e "${GREEN}âœ… This is where services run${NC}"
    echo -e "${GREEN}âœ… Use default ports: 4000 (backend), 5173 (frontend)${NC}"
    echo ""
    
    if [ -z "$LOCAL_MODE_AUTHORIZED" ]; then
        echo -e "${YELLOW}âš ï¸  Warning: LOCAL_MODE_AUTHORIZED not set${NC}"
        echo -e "${YELLOW}   AI agents should not modify code on main tree${NC}"
        echo -e "${YELLOW}   Set LOCAL_MODE_AUTHORIZED=1 if you're working locally${NC}"
    else
        echo -e "${GREEN}âœ… LOCAL_MODE_AUTHORIZED - code changes permitted${NC}"
    fi
else
    echo -e "${CYAN}ğŸ”§ WORKTREE (Code Editing Only)${NC}"
    echo ""
    echo -e "${GREEN}âœ… Edit code and commit freely here${NC}"
    echo -e "${RED}âŒ Don't run services in worktrees${NC}"
    echo ""
    echo -e "${BLUE}To test your changes:${NC}"
    echo -e "   1. Commit your code here"
    echo -e "   2. Switch main tree: ${CYAN}cd ~/ScreenGraph/Code/ScreenGraph && git checkout $BRANCH${NC}"
    echo -e "   3. Services auto-reload on main tree"
    echo -e "   4. Test at: ${CYAN}http://localhost:5173${NC}"
fi
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 3: Check Services (Main Tree Only)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if [ "$WORKTREE_NAME" = "ScreenGraph" ]; then
    echo -e "${BLUE}ğŸŒ Step 3: Service Status${NC}"
    
    # Check backend
    if lsof -ti:4000 > /dev/null 2>&1; then
        BACKEND_PID=$(lsof -ti:4000)
        echo -e "   ${GREEN}âœ“${NC} Backend running (PID $BACKEND_PID, port 4000)"
    else
        echo -e "   ${YELLOW}âš ${NC} Backend not running"
        echo -e "      Start: ${CYAN}./scripts/dev-backend.sh${NC}"
    fi
    
    # Check frontend
    if lsof -ti:5173 > /dev/null 2>&1; then
        FRONTEND_PID=$(lsof -ti:5173)
        echo -e "   ${GREEN}âœ“${NC} Frontend running (PID $FRONTEND_PID, port 5173)"
    else
        echo -e "   ${YELLOW}âš ${NC} Frontend not running"
        echo -e "      Start: ${CYAN}./scripts/dev-frontend.sh${NC}"
    fi
    echo ""
fi

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 4: Git Status
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${BLUE}ğŸ“ Step 4: Git Status${NC}"
UNCOMMITTED=$(git status --porcelain | wc -l | tr -d ' ')
echo -e "   Uncommitted changes: ${GREEN}$UNCOMMITTED${NC}"

if [ "$WORKTREE_NAME" != "ScreenGraph" ] && [ "$UNCOMMITTED" -gt 0 ]; then
    echo -e "   ${GREEN}âœ“${NC} Code changes in worktree (expected)"
elif [ "$WORKTREE_NAME" = "ScreenGraph" ] && [ "$UNCOMMITTED" -gt 0 ]; then
    echo -e "   ${YELLOW}âš ${NC} Uncommitted changes on main tree"
    echo -e "      Consider creating a worktree for this work"
fi
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Summary
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸ“Š Summary${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ "$WORKTREE_NAME" = "ScreenGraph" ]; then
    echo -e "${GREEN}âœ… Main tree setup verified${NC}"
    echo ""
    echo -e "${BLUE}Services should run here:${NC}"
    echo -e "   Backend:   ${CYAN}http://localhost:4000${NC}"
    echo -e "   Frontend:  ${CYAN}http://localhost:5173${NC}"
    echo -e "   Dashboard: ${CYAN}http://localhost:9400${NC}"
else
    echo -e "${GREEN}âœ… Worktree setup verified${NC}"
    echo ""
    echo -e "${BLUE}Worktree Purpose:${NC}"
    echo -e "   âœ… Code editing and commits"
    echo -e "   âŒ Don't run services here"
    echo ""
    echo -e "${BLUE}To test your code:${NC}"
    echo -e "   ${CYAN}cd ~/ScreenGraph/Code/ScreenGraph${NC}"
    echo -e "   ${CYAN}git checkout $BRANCH${NC}"
    echo -e "   ${CYAN}# Test at http://localhost:5173${NC}"
fi
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… Verification complete!${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

