#!/bin/bash
# Verify Worktree Isolation
# 
# Purpose: Run this FIRST in any new worktree to verify port isolation is working
# 
# This command:
# 1. Detects current worktree
# 2. Shows assigned ports
# 3. Checks for port conflicts
# 4. Verifies registry is correct
# 5. Optionally starts services to test
# 
# Usage:
#   @verify-worktree-isolation in Cursor chat
#   or
#   .cursor/commands/verify-worktree-isolation

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸ” Worktree Isolation Verification${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Change to repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$SCRIPT_DIR/../.."
cd "$REPO_ROOT"

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 1: Detect Worktree
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${BLUE}ğŸ“ Step 1: Detecting Worktree${NC}"
WORKTREE_NAME=$(basename $(git rev-parse --show-toplevel))
echo -e "   Worktree: ${GREEN}$WORKTREE_NAME${NC}"
echo ""

# Check if main tree
if [ "$WORKTREE_NAME" = "ScreenGraph" ]; then
    echo -e "${YELLOW}âš ï¸  You are on the MAIN tree (ScreenGraph)${NC}"
    echo -e "${YELLOW}   Main tree uses base ports with offset.${NC}"
    echo ""
fi

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 2: Get Assigned Ports
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${BLUE}ğŸ”¢ Step 2: Port Assignment${NC}"
PORT_JSON=$(bun ./scripts/port-coordinator.mjs --json)
BACKEND_PORT=$(echo "$PORT_JSON" | grep -o '"backend": [0-9]*' | grep -o '[0-9]*')
FRONTEND_PORT=$(echo "$PORT_JSON" | grep -o '"frontend": [0-9]*' | grep -o '[0-9]*')
DASHBOARD_PORT=$(echo "$PORT_JSON" | grep -o '"dashboard": [0-9]*' | grep -o '[0-9]*')
APPIUM_PORT=$(echo "$PORT_JSON" | grep -o '"appium": [0-9]*' | grep -o '[0-9]*')

echo -e "   Backend:   ${GREEN}$BACKEND_PORT${NC}"
echo -e "   Frontend:  ${GREEN}$FRONTEND_PORT${NC}"
echo -e "   Dashboard: ${GREEN}$DASHBOARD_PORT${NC}"
echo -e "   Appium:    ${GREEN}$APPIUM_PORT${NC}"
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 3: Check for Port Conflicts
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${BLUE}ğŸ” Step 3: Checking Port Availability${NC}"

check_port() {
    local port=$1
    local service=$2
    local pid=$(lsof -ti:$port 2>/dev/null || echo "")
    
    if [ -z "$pid" ]; then
        echo -e "   ${GREEN}âœ“${NC} Port $port ($service) is free"
        return 0
    else
        local process_name=$(ps -p $pid -o comm= 2>/dev/null || echo "unknown")
        echo -e "   ${YELLOW}âš ${NC} Port $port ($service) occupied by PID $pid ($process_name)"
        return 1
    fi
}

CONFLICTS=0
check_port $BACKEND_PORT "backend" || CONFLICTS=$((CONFLICTS + 1))
check_port $FRONTEND_PORT "frontend" || CONFLICTS=$((CONFLICTS + 1))
check_port $DASHBOARD_PORT "dashboard" || CONFLICTS=$((CONFLICTS + 1))
check_port $APPIUM_PORT "appium" || CONFLICTS=$((CONFLICTS + 1))
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 4: Check Registry
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${BLUE}ğŸ“‹ Step 4: Registry Status${NC}"
REGISTRY_PATH="$HOME/.screengraph/ports.json"

if [ -f "$REGISTRY_PATH" ]; then
    echo -e "   ${GREEN}âœ“${NC} Registry exists: $REGISTRY_PATH"
    
    # Show all worktrees in registry
    echo -e "\n   ${CYAN}Registered Worktrees:${NC}"
    cat "$REGISTRY_PATH" | grep -E '^\s*"[^"]+":' | sed 's/[",:]//g' | sed 's/^/      - /'
    
    # Check if current worktree is registered
    if grep -q "\"$WORKTREE_NAME\"" "$REGISTRY_PATH"; then
        echo -e "\n   ${GREEN}âœ“${NC} Current worktree ($WORKTREE_NAME) is registered"
    else
        echo -e "\n   ${YELLOW}âš ${NC} Current worktree ($WORKTREE_NAME) not yet in registry"
        echo -e "      Will be added when services start"
    fi
else
    echo -e "   ${YELLOW}âš ${NC} Registry not found (will be created on first run)"
fi
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 5: Check for Other Running Worktrees
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${BLUE}ğŸŒ³ Step 5: Other Active Worktrees${NC}"

# Check for Encore processes on other ports
ENCORE_PROCS=$(ps aux | grep 'encore run' | grep -v grep || echo "")
if [ -z "$ENCORE_PROCS" ]; then
    echo -e "   ${CYAN}â„¹${NC} No other Encore backends running"
else
    echo -e "   ${GREEN}âœ“${NC} Other backends detected (multi-agent mode):"
    echo "$ENCORE_PROCS" | while read line; do
        PORT=$(echo "$line" | grep -o 'port=[0-9]*' | grep -o '[0-9]*' || echo "unknown")
        PID=$(echo "$line" | awk '{print $2}')
        echo -e "      - PID $PID on port $PORT"
    done
fi
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 6: Verification Summary
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸ“Š Verification Summary${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ $CONFLICTS -eq 0 ]; then
    echo -e "${GREEN}âœ… All ports are available${NC}"
    echo -e "${GREEN}âœ… Worktree isolation is correctly configured${NC}"
    echo -e "${GREEN}âœ… Ready to start services${NC}"
else
    echo -e "${YELLOW}âš ï¸  $CONFLICTS port(s) currently occupied${NC}"
    echo -e "${YELLOW}   This is OK if services are already running for this worktree${NC}"
    echo -e "${YELLOW}   Use 'lsof -ti:<port>' to identify processes${NC}"
fi
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Step 7: Next Steps
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸš€ Next Steps${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BLUE}To start services for this worktree:${NC}"
echo ""
echo -e "   ${GREEN}# Terminal 1: Backend${NC}"
echo -e "   ./scripts/dev-backend.sh"
echo ""
echo -e "   ${GREEN}# Terminal 2: Frontend${NC}"
echo -e "   ./scripts/dev-frontend.sh"
echo ""
echo -e "${BLUE}Services will run on:${NC}"
echo -e "   Backend:   ${CYAN}http://localhost:$BACKEND_PORT${NC}"
echo -e "   Frontend:  ${CYAN}http://localhost:$FRONTEND_PORT${NC}"
echo -e "   Dashboard: ${CYAN}http://localhost:$DASHBOARD_PORT${NC}"
echo ""
echo -e "${BLUE}To verify isolation after starting:${NC}"
echo -e "   curl http://localhost:$FRONTEND_PORT  # Should load frontend"
echo -e "   curl http://localhost:$BACKEND_PORT/health  # Should show backend health"
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… Verification complete!${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

