#!/bin/bash

# Create Feature Request Folder
# Usage: When @-mentioned in Cursor, this command sets up a new feature request folder
# Auto-increments feature number based on existing feature requests

# Find the highest FR-XXX number in feature-requests directory
HIGHEST_NUM=$(find jira/feature-requests -maxdepth 1 \( -type f -o -type d \) -name "FR-[0-9]*" | \
  sed 's/.*FR-\([0-9]\{3\}\).*/\1/' | \
  sort -n | \
  tail -1)

# Increment to get next number
if [ -z "$HIGHEST_NUM" ]; then
    NEXT_NUM=1
else
    NEXT_NUM=$((10#$HIGHEST_NUM + 1))
fi

# Format as FR-XXX
FEATURE_ID=$(printf "FR-%03d" $NEXT_NUM)

echo "ğŸ”¢ Auto-generated Feature ID: ${FEATURE_ID}"
echo ""

# Get the title from user input
read -p "Short Title (kebab-case, e.g., api-rate-limiting): " TITLE

# Validate input
if [ -z "$TITLE" ]; then
    echo "âŒ Error: Title is required"
    exit 1
fi

# Create folder name
FOLDER_NAME="${FEATURE_ID}-${TITLE}"
FOLDER_PATH="jira/feature-requests/${FOLDER_NAME}"

# Check if folder already exists
if [ -d "$FOLDER_PATH" ]; then
    echo "âŒ Error: Folder ${FOLDER_PATH} already exists"
    exit 1
fi

# Create the folder
mkdir -p "$FOLDER_PATH"

# Copy templates and rename them
cp jira/feature-requests/TEMPLATE-main.md "${FOLDER_PATH}/${FEATURE_ID}-main.md"
cp jira/feature-requests/TEMPLATE-retro.md "${FOLDER_PATH}/${FEATURE_ID}-retro.md"
cp jira/feature-requests/TEMPLATE-status.md "${FOLDER_PATH}/${FEATURE_ID}-status.md"

# Replace placeholders in the main file
sed -i.bak "s/FR-XXX/${FEATURE_ID}/g" "${FOLDER_PATH}/${FEATURE_ID}-main.md"
sed -i.bak "s/\[Short Title\]/${TITLE}/g" "${FOLDER_PATH}/${FEATURE_ID}-main.md"
rm "${FOLDER_PATH}/${FEATURE_ID}-main.md.bak"

# Replace placeholders in retro
sed -i.bak "s/FR-XXX/${FEATURE_ID}/g" "${FOLDER_PATH}/${FEATURE_ID}-retro.md"
sed -i.bak "s/\[Short Title\]/${TITLE}/g" "${FOLDER_PATH}/${FEATURE_ID}-retro.md"
rm "${FOLDER_PATH}/${FEATURE_ID}-retro.md.bak"

# Replace placeholders in status
sed -i.bak "s/FR-XXX/${FEATURE_ID}/g" "${FOLDER_PATH}/${FEATURE_ID}-status.md"
sed -i.bak "s/\[Short Title\]/${TITLE}/g" "${FOLDER_PATH}/${FEATURE_ID}-status.md"
rm "${FOLDER_PATH}/${FEATURE_ID}-status.md.bak"

# Inject Release Plan & Procedures references into main ticket
cat >> "${FOLDER_PATH}/${FEATURE_ID}-main.md" << 'EOF'

---

## Release Plan (PROC-001)
- Follow PROC-001 â€œProduction Releaseâ€ in `.cursor/procedures/PROCEDURES.md`
- Preconditions:
  - [ ] `@verify-worktree-isolation` passes
  - [ ] `@test-default-run` passes on this worktree
- Handoff:
  - After merge to main, run `@update_handoff` and choose the â€œProduction Release Updateâ€ workflow
- Notes:
  - Frontend version bump (semver) required before tagging
  - Tag format: `v<frontend>-<date>-<shortsha>`

## Worktree Setup Quicklinks
- Isolation: `@verify-worktree-isolation`
- Start Backend: `./scripts/dev-backend.sh`
- Start Frontend: `./scripts/dev-frontend.sh`
- Smoke Test: `@test-default-run`

EOF

echo "âœ… Feature request folder created: ${FOLDER_PATH}"
echo ""
echo "ğŸ“ Created files:"
echo "   - ${FEATURE_ID}-main.md (main ticket)"
echo "   - ${FEATURE_ID}-retro.md (retrospective)"
echo "   - ${FEATURE_ID}-status.md (status report)"
echo ""
echo "ğŸš€ Next steps:"
echo "   1. Fill out ${FEATURE_ID}-main.md with feature details"
echo "   2. Run @verify-worktree-isolation then start services"
echo "   3. Validate with @test-default-run"
echo "   4. When ready for prod, run @update_handoff and select â€œProduction Release Updateâ€"

