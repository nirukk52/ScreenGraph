version: '3'

# Backend commands
# Backend-specific development tasks

tasks:
  dev:
    desc: "Start backend development server"
    cmds:
      - echo "ğŸ”§ Starting backend..."
      - cd ../../../backend && encore run
    silent: false

  logs:
    desc: "View backend logs"
    cmds:
      - tail -f ../../backend.log
    silent: false

  health:
    desc: "Check backend health"
    cmds:
      - echo "â¤ï¸  Checking backend health..."
      - curl -f http://localhost:${BACKEND_PORT:-4000}/health || echo "âš ï¸  Backend not responding"
    silent: false

  db:migrate:
    desc: "Run database migrations"
    cmds:
      - echo "ğŸ”„ Running database migrations..."
      - cd ../../../backend && encore db migrate
      - echo "âœ… Migrations complete"
    silent: false

  db:reset:
    desc: "Reset database (DESTRUCTIVE)"
    prompt: "This will delete all data. Continue?"
    cmds:
      - echo "âš ï¸  Resetting database..."
      - cd ../../../backend && encore db reset
      - echo "âœ… Database reset complete"
    silent: false

  db:shell:
    desc: "Open database shell"
    cmds:
      - cd ../../../backend && encore db shell run --write
    silent: false

  test:
    desc: "Run backend tests"
    cmds:
      - echo "ğŸ§ª Running backend tests..."
      - cd ../../../backend && encore test
    silent: false

  integration:metrics:
    desc: "Verify metrics via full agent run (requires backend + Appium harness)"
    cmds:
      - echo "Validating prerequisites for metrics integration test..."
      - echo "Phase 1 - Health Checks (backend-debugging_skill)"
      - >
        if ! command -v adb >/dev/null 2>&1; then
          echo "âŒ adb not found. Install Android platform tools."; exit 1;
        fi
      - >
        if ! adb devices | grep -E "device$" | grep -v "^List" >/dev/null 2>&1; then
          echo "âŒ No Android device/emulator detected via 'adb devices'."; exit 1;
        else
          echo "âœ… Android device detected.";
        fi
      - >
        APPIUM_URL=${VITE_APPIUM_SERVER_URL:-http://127.0.0.1:4723/};
        echo "ğŸ“¡ Checking Appium server at $APPIUM_URL ...";
        if curl -sf "$APPIUM_URL/status" >/dev/null 2>&1 || curl -sf "$APPIUM_URL/wd/hub/status" >/dev/null 2>&1; then
          echo "âœ… Appium server already running.";
        else
          echo "âš¡ Appium not running. Starting via dev-android-appium.sh...";
          (cd ../../../backend && bash scripts/dev-android-appium.sh) || {
            echo "âŒ Failed to start Appium. Check logs at \$TMPDIR/appium.log";
            exit 1;
          };
        fi
      - echo "Phase 2 - Skipping Backend Health Check"
      - >
        echo "â„¹ï¸  Backend health check skipped - test runs in isolated encore test runtime";
        echo "â„¹ï¸  Worker subscription will be loaded via import in test file";
        echo "â„¹ï¸  Use Encore MCP tools to inspect test results after run";
      - echo "Phase 3 - Running Integration Test"
      - >
        echo "ğŸ“ Prerequisites:";
        echo "   âœ… Appium Inspector running manually";
        echo "   âœ… Android Studio emulator running manually";
        echo "   âœ… App installed from .env (VITE_PACKAGE_NAME)";
        echo "";
        echo "ğŸ” Debugging with Encore MCP:";
        echo "   After test runs, use Encore MCP tools to inspect:";
        echo "   - mcp_encore-mcp_get_services (service status)";
        echo "   - mcp_encore-mcp_get_traces (recent traces)";
        echo "   - mcp_encore-mcp_query_database (run details)";
        echo "";
      - echo "ğŸš€ Starting metrics test (encore test with worker subscription loaded)..."
      - cd ../../../backend && encore test agent/tests/metrics.test.ts
    silent: false
