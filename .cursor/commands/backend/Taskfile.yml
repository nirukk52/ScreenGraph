version: '3'

# Backend database management
# Encore maintains separate database clusters for dev (encore run) and test (encore test)

tasks:
  # Dev cluster commands (for encore run)
  db:migrate:
    desc: "Run migrations on dev cluster"
    cmds:
      - echo "üîÑ Running migrations on dev cluster..."
      - cd ../../../backend && encore db migrate
      - echo "‚úÖ Dev cluster migrations complete"
    silent: false

  db:reset:
    desc: "Reset dev cluster database (DESTRUCTIVE)"
    prompt: "This will delete all DEV data. Continue?"
    cmds:
      - echo "‚ö†Ô∏è  Resetting dev cluster database..."
      - cd ../../../backend && encore db reset --all
      - echo "‚úÖ Dev cluster database reset"
    silent: false

  db:shell:
    desc: "Open dev cluster database shell. To be used along side encore run."
    cmds:
      - echo "üóÑÔ∏è  Opening dev cluster shell..."
      - cd ../../../backend && encore db shell db --write
    silent: false

  # Test cluster commands (for encore test)
  db:migrate:test:
    desc: "Run migrations on test cluster"
    cmds:
      - echo "üîÑ Running migrations on test cluster..."
      - cd ../../../backend && encore db migrate --test
      - echo "‚úÖ Test cluster migrations complete"
    silent: false

  db:reset:test:
    desc: "Reset test cluster database (DESTRUCTIVE)"
    cmds:
      - echo "‚ö†Ô∏è  Resetting test cluster database..."
      - cd ../../../backend && encore db reset --all --test
      - echo "‚úÖ Test cluster database reset"
    silent: false

  db:shell:test:
    desc: "Open test cluster database shell. To be used when debugging backend tests."
    cmds:
      - echo "üóÑÔ∏è  Opening test cluster shell..."
      - cd ../../../backend && encore db shell db --test --write
    silent: false

  # Utility commands
  db:status:
    desc: "Show database connection info for both clusters"
    cmds:
      - echo "üìä Database Status"
      - echo ""
      - echo "Dev Cluster (encore run):"
      - cd ../../../backend && encore db conn-uri db 2>&1 || echo "  ‚ö†Ô∏è  Dev cluster not available"
      - echo ""
      - echo "Test Cluster (encore test):"
      - cd ../../../backend && encore db conn-uri db --test 2>&1 || echo "  ‚ö†Ô∏è  Test cluster not available"
    silent: false
