---
alwaysApply: true
---

# Founder Rules â€” ScreenGraph Development Standards

> **Purpose**: Non-negotiable rules for all development. Enforce isolation, type safety, naming standards, and multi-agent worktree discipline.

---

## ğŸ“‘ Table of Contents

### Part I: Core Coding Standards
1. [Architecture & Boundaries](#architecture--boundaries)
2. [Naming Conventions](#naming-conventions-critical)
3. [Type Safety](#type-safety-no-exceptions)
4. [Documentation & Comments](#documentation--comments)
5. [No Magic Strings/Numbers](#no-magic-stringsnumbers)
6. [Spelling & Language](#spelling--language)
7. [Logging Standards](#logging-standards)
8. [Testing Philosophy](#testing-philosophy)
9. [API Clients](#api-clients)
10. [Package Management](#package-management)
11. [Commands](#commands)
12. [Build & Deployment](#build--deployment)
13. [Handoff Documentation](#handoff-documentation)

### Part II: Worktree Isolation
14. [Worktree Detection (Pre-Flight)](#worktree-detection-run-first-always)
15. [Main Tree Protection](#main-tree-is-read-only-for-agents)
16. [Port Reservation Policy](#port-reservation-policy)
17. [Development Flow](#correct-development-flow)
18. [Cursor Modes](#cursor-dropdown-modes)
19. [Enforcement Rules](#enforcement-what-agents-cannot-do)

---

## Part I: Core Coding Standards (ALWAYS)

### ğŸ—ï¸ Architecture & Boundaries

**Backend/Frontend Separation:**
- Backend (`backend/`) and frontend (`frontend/`) are completely independent services
- No shared code or `node_modules` between them
- No root `package.json` or `encore.app`
- Backend never imports frontend; frontend never touches backend code
- No root-level coupling: root only holds docs and Git config

**Directory Structure:**
```
/ScreenGraph
â”œâ”€â”€ backend/          â† Encore backend (independent)
â”‚   â”œâ”€â”€ encore.app
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ bun.lock
â”œâ”€â”€ frontend/         â† SvelteKit frontend (independent)
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ bun.lock
â””â”€â”€ README.md         â† Docs, shared tsconfig, biome config
```

**Absolute Prohibitions:**
- âŒ No root package.json
- âŒ No root encore.app
- âŒ No shared node_modules
- âŒ No backendâ†”frontend imports
- âŒ No manual HTTP fetches (use Encore generated clients)

---

### ğŸ“› Naming Conventions (CRITICAL)

**Function names MUST be descriptive verb phrases:**
- âœ… `calculateTotalPrice`, `fetchUserProfile`, `saveScreenshot`, `handleDeviceConnection`
- âŒ `handle()`, `process()`, `doStuff()`, `manager()`

**Class names MUST be singular nouns or noun phrases:**
- âœ… `ScreenGraphProjector`, `AgentOrchestrator`, `RunEventPublisher`
- âŒ `Hasher`, `Mapper`, `Processor`, `Manager` (too generic)

**Domain-oriented, not tech-oriented:**
- âœ… `ScreenHasher`, `RunEventMapper`, `AgentStateProcessor`
- âŒ `Hasher`, `Mapper`, `Processor` (missing business context)

---

### ğŸ”’ Type Safety (NO EXCEPTIONS)

**Absolutely NO `any` type:**
- Every function, class, API endpoint MUST use explicit types
- DTOs (Data Transfer Objects) defined at top of file or imported
- Dynamic data â†’ `Record<string, unknown>` or `{ [key: string]: unknown }`
- Never fallback to `any`

**Typed APIs:**
- Always use Encore generated clients (`~encore/clients`)
- Never manual `fetch()` calls
- After backend changes â†’ run `bun run gen` on frontend
- Full end-to-end type safety guaranteed

**Examples:**
```typescript
interface StartRunRequest { appId: string; deviceId: string; policy?: "breadth" | "depth"; }
function startRun(req: StartRunRequest): Promise<RunResponse> {}
// BAD: avoid `any`
```

---

### ğŸ“ Documentation & Comments

**Every function, class, enum, DTO MUST have a purpose comment:**
```typescript
/** Calculates perceptual hash of a screenshot for deduplication. */
export function calculateScreenHash(image: Buffer): string {}
```

---

### ğŸš« No Magic Strings/Numbers

**Define literal unions or enums:**
```typescript
type AgentStatus = "idle" | "planning" | "acting" | "completed";
const RUN_STATUS = { ACTIVE: "active", CANCELED: "canceled", COMPLETED: "completed" } as const;
if (status === RUN_STATUS.ACTIVE) { /* ... */ }
```

---

### ğŸŒ Spelling & Language

**Use American English exclusively:**
- âœ… `canceled`, `color`, `optimize`, `initialize`
- âŒ `cancelled`, `colour`, `optimise`, `initialise`

**Applies to:** variable names, function names, enums, DB columns, types, comments, docs

---

### ğŸ“Š Logging Standards

**Use ONLY `encore.dev/log` (NEVER `console.log`):**
```typescript
import log from "encore.dev/log";

const logger = log.with({ module: "agent", actor: "worker", runId: "abc123" });
logger.info("state transition", { from: "idle", to: "planning" });
logger.error("device connection failed", { err: error.message, deviceId });
```

**Required fields:** `module`, `actor`, `runId` (when applicable)  
**On failures:** Include `stopReason` and `err.*` fields  
**Always structured JSON** â€” never unstructured strings

---

### ğŸ§ª Testing Philosophy

**Test for flow reliability and correctness:**
- High-level flow tests (not edge cases or petty tests)
- Focus on creative consistency
- Verify end-to-end behavior

**Commands:**
- Backend: `encore test`
- Frontend: `bun run test`

---

### ğŸ¯ API Clients

**Always use Encore generated clients:**
```typescript
import { run } from '~encore/clients';
const result = await run.start({ appId: 'com.example' });
// BAD: manual fetch
```

**Workflow:**
1. Update backend API endpoint
2. Run `bun run gen` in frontend
3. Use new types in frontend code
4. Full type safety end-to-end

---

### ğŸ“¦ Package Management

**Use Bun exclusively:**
- All projects: `"packageManager": "bun"`
- Backend: `cd backend && bun install`
- Frontend: `cd frontend && bun install`

---

### ğŸš€ Commands

**Backend:**
```bash
cd backend && encore run
```

**Frontend:**
```bash
cd frontend && bun run dev
```

**NEVER run from root** â€” always `cd` into service directory

---

### ğŸŒ Build & Deployment

**Backend:** Encore Cloud CI (no manual build scripts)  
**Frontend:** `vite build` â†’ Deploy to Vercel  
**Deploy independently** â€” backend and frontend are separate

---

### ğŸ“‹ Handoff Documentation

**Maintain these files at root:**
- `BACKEND_HANDOFF.md` â€” Backend architecture summary
- `FRONTEND_HANDOFF.md` â€” Frontend architecture summary

Update after significant changes.

---

## Part II: Worktree Isolation (Multi-Agent Development)

### ğŸš¨ Worktree Detection (Run FIRST, Always)

**Before executing ANY command, you MUST:**

1. **Detect current worktree mode** from Cursor's dropdown
2. **Verify you are NOT on main tree** (unless Local mode)
3. **Confirm port assignments** are coordinated

**Pre-Flight Check (Required Before ANY Task):**

```bash
TREE_NAME=$(basename $(git rev-parse --show-toplevel))

# Block if on main tree without Local mode authorization
if [ "$TREE_NAME" = "ScreenGraph" ] && [ -z "$LOCAL_MODE_AUTHORIZED" ]; then
  echo "ğŸš« STOP: You are on MAIN tree (ScreenGraph)"
  echo "âœ… Switch Cursor to 'Worktree' mode or create feature branch"
  exit 1
fi

# If in worktree, verify coordinated ports
if [ "$TREE_NAME" != "ScreenGraph" ]; then
  eval "$(bun ./scripts/port-coordinator.mjs --no-summary)"
  [ "$BACKEND_PORT" != "4000" ] || { echo "âŒ Using main tree ports"; exit 1; }
  echo "âœ… Worktree: $TREE_NAME | Backend: $BACKEND_PORT | Frontend: $FRONTEND_PORT"
fi
```

---

### ğŸ”’ Main Tree is Read-Only for Agents

- âŒ **NEVER** run `encore run` or `bun run dev` on main tree
- âŒ **NEVER** modify files or commit on main tree
- âœ… **EXCEPTION**: Only when Cursor dropdown shows **"Local"** mode

---

### ğŸ“ Port Reservation Policy

| Environment | Backend | Frontend | Dashboard | Appium |
|-------------|---------|----------|-----------|--------|
| **Main Tree** | **4000** | **5173** | **9400** | **4723** |
| Worktree 1-20 | 4001-4009 | 5174-5183 | 9401-9409 | 4724-4733 |

**Main tree ports are RESERVED** â€” worktrees use port coordinator for automatic assignment.

---

### ğŸš€ Correct Development Flow

**For Worktree Agents (Default):**

```bash
# 1. Verify NOT on main tree
[ "$(basename $(git rev-parse --show-toplevel))" != "ScreenGraph" ] || exit 1

# 2. Start services with port coordination (from repo root)
./scripts/dev-backend.sh   # Assigns 4001-4009
./scripts/dev-frontend.sh  # Assigns 5174-5183
```

**For Local Mode (Main Tree Only):**

```bash
# Only when Cursor shows "Local" in dropdown
cd backend && encore run        # Uses default 4000
cd frontend && bun run dev      # Uses default 5173
```

---

### ğŸ¨ Cursor Dropdown Modes

**"Local" Mode:**
- âœ… Authorized for main tree (default ports: 4000, 5173)
- ğŸ¯ Use: Single developer, quick fixes

**"Worktree" Mode (Default for Agents):**
- âŒ Cannot work on main tree
- âœ… Must use coordinated ports via `./scripts/dev-backend.sh` and `./scripts/dev-frontend.sh`
- âœ… Must work on feature branches (never `main`)
- ğŸ¯ Use: Multi-agent development, parallel features

---

### ğŸš« Enforcement: What Agents CANNOT Do

1. âŒ `encore run` directly (use `./scripts/dev-backend.sh`)
2. âŒ Work on main tree without Local mode
3. âŒ Use default ports (4000, 5173) in worktrees
4. âŒ Commit directly to `main` branch
5. âŒ Skip worktree detection before commands

---

### âœ… Enforcement: What Agents MUST Do

1. âœ… Run worktree detection FIRST
2. âœ… Use `./scripts/dev-backend.sh` and `./scripts/dev-frontend.sh` for all services
3. âœ… Verify coordinated ports (not defaults)
4. âœ… Work on feature branches only
5. âœ… Include worktree name in logs/commits

---

## ğŸ“ The One Rule

> **If you're an AI agent and `basename $(git rev-parse --show-toplevel)` returns "ScreenGraph", STOP. You are on the main tree. Switch to Worktree mode or await Local mode authorization.**

**Default Assumption**: All agents work in Worktree mode with coordinated ports. Main tree is sacred and untouchable unless explicitly in Local mode.

---

**Last Updated**: 2025-11-06  
**Owner**: Founder  
**Enforcement**: Automatic via pre-flight checks  
**Violations**: Block immediately, provide clear remediation
