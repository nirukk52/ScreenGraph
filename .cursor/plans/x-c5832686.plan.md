<!-- c5832686-2990-4dcc-83cf-b34cf1f00984 fe9faa42-1bd3-4129-9ccb-b8f372669dc3 -->
# Phase 2 — XState Migration (Deterministic Orchestration)

## Scope & Outcomes

- Move retry/backoff/backtrack policy from `backend/agent/engine/transition-policy.ts` and NodeEngine into XState guards/actions.
- Remove AgentRunner fallback and make XState the only driver in `backend/agent/orchestrator/worker.ts`.
- Replace SwitchPolicy-based routing with a dedicated router (code-level decision) so SwitchPolicy only switches run policies (BFS/DFS/MaxCoverage/Focused/GoalOriented).
- Add a dev-only XState Inspector and share the command/URL to open the portal.

## Key Decisions

- SwitchPolicy will no longer participate in main-path routing; routing will be decided by a pure function used by the XState machine.
- Introduce a raw node execution surface (no transitions) for the machine to interpret (retry/backtrack/advance) deterministically.
- Keep structured logging and snapshot persistence unchanged; all logs via `encore.dev/log`.

## Implementation Steps

### 1) Introduce raw node execution surface

- Add a raw execution API in `backend/agent/engine/node-engine.ts` (e.g., `runNodeRaw`) that returns only: node name executed, outcome (success/failure), output, events, and `retryable` flag—no `nextNode`, `retryDelayMs`, or backtrack.
- Update `backend/agent/engine/xstate/services.ts` to call the raw API for XState; keep legacy `runOnce` temporarily for the runner until removal.
- Maintain existing node capsules under `backend/agent/nodes/**` (no changes to handler business logic).

### 2) Move policy (retry/backoff/backtrack) into XState

- Create `backend/agent/engine/xstate/policy.ts` for guards/actions that compute:
- Retry eligibility (attempt < maxAttempts AND `retryable != false`).
- Backoff delay (exponential with deterministic jitter using the same seed) replacing `computeBackoffDelayMs` from `transition-policy.ts`.
- Backtrack target (e.g., exhausted retries for ProvisionApp → EnsureDevice), increment `restartsUsed` in state.
- Wire guards/actions in `backend/agent/engine/xstate/machine.ts` so the machine decides: retry (delayed transition), backtrack (advance to fallback node), or advance (success path) based solely on raw outcomes.

### 3) Extract routing out of SwitchPolicy

- Add/expand a dedicated router (pure function) in `backend/agent/orchestrator/router.ts` (or `backend/agent/engine/xstate/router.ts` if preferred). This returns the next node based on `AgentState` and run intent, not policy switching.
- Update machine’s success path to call the router to compute the next node. Keep SwitchPolicy capsule only for explicit run policy changes (BFS/DFS/etc.). Remove any green-path transitions that point to SwitchPolicy (e.g., WaitIdle → SwitchPolicy → Stop) and instead point to the actual next node via the router (e.g., WaitIdle → Perceive → …).

### 4) Make XState the only driver

- In `backend/agent/orchestrator/worker.ts`:
- Remove the `AGENT_DRIVER` branching and all `AgentRunner` usage.
- Create and start the XState actor unconditionally; preserve callbacks for `onPersist` and `onAttempt`.
- Delete the runner-specific code paths once tests pass.

### 5) Logging, budgets, cancellation

- Keep `shouldStop` budget/cancellation gate as an XState-invoked actor (unchanged), ensuring budget checks run before each node attempt.
- Ensure logs include `{ module, actor, runId, workerId, nodeName, stepOrdinal }` and capture snapshot on transitions.

### 6) Tests

- Expand `backend/agent/engine/xstate/machine.test.ts` to cover:
- Retry timing (bounded exponential with deterministic jitter).
- Backtrack after exhausted retries, incrementing `restartsUsed`.
- Router-driven advancement (no SwitchPolicy in green path).
- Remove/update any runner-specific tests.

### 7) Docs & handoff

- Update `HANDOFF.md` with Phase 2 completion notes, and reference files changed.
- Update `backend/agent/CLAUDE.md` (retry/backoff now in XState; SwitchPolicy purpose clarified).

### 8) XState Inspector (dev-only)

- Add inspector wiring (dev-only) to the XState driver instantiation before `createActor` in `worker.ts`.
- Print the Inspector link on startup (it will be of the form: `https://stately.ai/inspect?server=ws://localhost:PORT`).
- Provide the run command and the URL pattern (see below).

## Deliverable: XState Portal Command/URL

- Command to run (local dev): set the inspector flag and start the backend
- `encore run` with the inspector enabled (dev-only)
- Open the inspector link printed in logs, which looks like:
- `https://stately.ai/inspect?server=ws://localhost:XXXXX`
- If your terminal did not show a link, open `https://stately.ai/inspect` and paste the `ws://localhost:XXXXX` URL from the logs.

### To-dos

- [ ] Add raw node execution surface in node-engine and wire services
- [ ] Implement retry/backoff/backtrack guards/actions in machine
- [ ] Move routing to dedicated router and remove SwitchPolicy from green path
- [ ] Remove AgentRunner fallback; make XState the only driver
- [ ] Verify logs, stop reasons, and budget checks still correct
- [ ] Expand machine tests for retry/backtrack/router; remove runner tests
- [ ] Update HANDOFF.md and CLAUDE docs to reflect Phase 2
- [ ] Add dev-only XState Inspector and print portal link