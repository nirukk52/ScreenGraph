<!-- 295ca531-2307-4073-88de-57325c55c650 f4808520-9328-4025-b100-455f73f50355 -->
# Pre‑ProvisionApp Hardening Plan

### Goal

Get the agent ready to implement `setup/ProvisionApp` by aligning with backend_agent_module_review.md: contextId in, artifact refs out, typed errors, explicit budgets, structured events.

### Scope (before ProvisionApp)

- No node behavior changes yet; only interfaces, adapters, and instrumentation to unblock ProvisionApp.
- Keep edits surgical, file‑scoped, and typed; no `any`.

### Tasks

- **Port hygiene (remove sessionId leakage)**
- Deprecate monolithic port and fakes:
- Remove `backend/agent/ports/appium/driver.port.ts` and `backend/agent/adapters/fakes/fake-driver.ts`.
- Grep usages and replace with granular ports (`session.port.ts`, `app-lifecycle.port.ts`, etc.).
- Fix residual signatures:
- `backend/agent/nodes/policy/restart-app.ts`: drop `sessionId` param; only use ports + `deviceRuntimeContextId`.

- **Driver error taxonomy**
- Add `DriverErrorKind` and mapper:
- Create `backend/agent/adapters/appium/error-kinds.ts` with enum: `DRIVER_TIMEOUT | SESSION_LOST | APP_NOT_FOREGROUND | INPUT_FAILED | VISIBILITY_STALE | WINDOW_METRICS_UNKNOWN | INTERNAL_DRIVER_ERROR` and mapper `mapAdapterErrorToDriverErrorKind(err: unknown): DriverErrorKind`.
- Update adapters to use taxonomy:
- `backend/agent/adapters/appium/webdriverio/app-lifecycle.adapter.ts`: map thrown errors to `DriverErrorKind`; rethrow with vendor detail under `payload.vendor` in logs/events.

- **Explicit time budgets (no implicit waits)**
- Introduce typed budgets DTO:
- Add `AppLifecycleBudget` in `backend/agent/ports/appium/app-lifecycle.port.ts` and change signatures to accept `{ launchTimeoutMs: number }`.
- Thread budgets from state:
- Ensure node handlers pass budgets from `AgentState` (e.g., `state.budgets.appLaunchTimeoutMs`).

- **Event schema + correlationId**
- Extend event kinds in `backend/agent/domain/events.ts`:
- Add: `agent.app.install_checked`, `agent.app.signature_verified`, `agent.app.launch_started`, `agent.app.launch_completed`, `agent.app.launch_failed`.
- Add payloads with `correlationId`, `packageId`, `attempt`, `durationMs`, and `errorKind?: DriverErrorKind`.
- Ensure `createDomainEvent` remains typed via `EventPayloadMap`.

- **APK install/signature primitives**
- Define dedicated port:
- Create `backend/agent/ports/appium/package-manager.port.ts` with:
- `isInstalled(packageId: string): Promise<{ installed: boolean; versionName?: string; versionCode?: number }>`
- `installFromObjectStorage(ref: string, expectedSha256?: string): Promise<{ packageId: string }>`
- `getSignatureSha256(packageId: string): Promise<string>`
- Adapters:
- Add WDIO stub: `backend/agent/adapters/appium/webdriverio/package-manager.adapter.ts` (methods implemented minimally or TODO with typed errors).
- Add fake: `backend/agent/adapters/fakes/fake-package-manager.adapter.ts` for tests.

- **Storage port unification**
- Consolidate on a single `StoragePort`:
- Keep richer variant `backend/agent/ports/storage.ts` and delete `backend/agent/ports/storage.port.ts`.
- Add a minimal in‑memory adapter under `backend/agent/adapters/fakes/fake-storage.adapter.ts`.

- **Logging instrumentation**
- Use `loggerWith` everywhere in node handlers and adapters:
- Create contextual logger with `{ module: "agent", actor: "worker" | "orchestrator" | "adapter", nodeName, runId, stepOrdinal }` and include `correlationId` on per‑call logs.

- **Conformance micro‑flow (sanity)**
- Add a lightweight test using fakes that executes: EnsureDevice → (stub) ProvisionApp → WaitIdle and asserts only on events emitted and payload types.

### Acceptance Criteria

- No `sessionId` parameters in any port/node surface.
- New `DriverErrorKind` present and used in WDIO app lifecycle adapter mapping.
- `app-lifecycle.port.ts` methods accept an explicit budget object.
- `domain/events.ts` includes new event kinds with typed payloads including `correlationId`.
- `package-manager.port.ts` exists with WDIO stub + fake; no untyped strings for status.
- Only one `StoragePort` remains; fake storage adapter added.
- CI/unit test runs with the conformance micro‑flow pass using fakes.

### File Touch List (minimal)

- Remove: `backend/agent/ports/appium/driver.port.ts`, `backend/agent/adapters/fakes/fake-driver.ts`.
- Update: `backend/agent/nodes/policy/restart-app.ts` (signature), `backend/agent/adapters/appium/webdriverio/app-lifecycle.adapter.ts` (error mapping, budgets), `backend/agent/domain/events.ts` (kinds/payloads), `backend/agent/ports/appium/app-lifecycle.port.ts` (budget DTO).
- Add: `backend/agent/adapters/appium/error-kinds.ts`, `backend/agent/ports/appium/package-manager.port.ts`, `backend/agent/adapters/appium/webdriverio/package-manager.adapter.ts`, `backend/agent/adapters/fakes/fake-package-manager.adapter.ts`, `backend/agent/adapters/fakes/fake-storage.adapter.ts`.

### To-dos

- [ ] Remove monolithic DriverPort and fake; replace any usages with granular ports
- [ ] Drop sessionId param from restart-app; rely on ports and contextId
- [ ] Add DriverErrorKind enum and mapper; wire into WDIO app-lifecycle adapter
- [ ] Add AppLifecycleBudget DTO; update app-lifecycle port+adapter to accept budgets
- [ ] Add ProvisionApp-related event kinds and payloads with correlationId
- [ ] Create package-manager.port.ts + WDIO stub + fake
- [ ] Consolidate to single StoragePort; add fake adapter
- [ ] Instrument node handlers/adapters with loggerWith + correlationId
- [ ] Add conformance micro-flow test using fakes; assert typed events