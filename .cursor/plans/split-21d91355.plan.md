<!-- 21d91355-6c43-4d7b-b7ff-094aea44888e 57bcb6b5-7073-430a-98f8-6ebd4684c2c3 -->
# Replace DriverPort with granular Appium ports and WebDriverIO implementations

## Goal

Replace the monolithic `DriverPort` with small, cohesive Appium-specific ports, implemented using the latest WebDriverIO Appium client. Preserve all Python docstrings (from `appium_for_referrence`) as TSDoc comments in TypeScript. Migrate nodes incrementally to the new ports, then retire the old driver.

## Deliverables

- New port interfaces under `backend/agent/ports/appium/` with preserved docstrings.
- WebDriverIO-based adapters under `backend/agent/adapters/appium/` implementing each port.
- A temporary façade that implements the old `DriverPort` by delegating to new ports for gradual migration.
- Updated nodes to depend on the narrow ports.
- Updated fakes aligned to each new port for tests.

## Port Design (small, cohesive interfaces)

- `session.port.ts`
                                                                                                                                - ensureDevice(DeviceConfiguration) → DeviceRuntimeContext
                                                                                                                                - closeSession() → void
                                                                                                                                - Notes: replaces `ensureDevice` usage in `nodes/setup/ensure-device.ts`.
- `app-lifecycle.port.ts`
                                                                                                                                - launchApp(packageId) → ApplicationForegroundContext
                                                                                                                                - restartApp(packageId) → boolean
                                                                                                                                - getCurrentApp() → string
                                                                                                                                - Notes: replaces `launch-or-attach.ts` usage.
- `perception.port.ts`
                                                                                                                                - captureScreenshot() → ScreenshotData
                                                                                                                                - dumpUiHierarchy() → UiHierarchyData
- `device-info.port.ts`
                                                                                                                                - getScreenDimensions() → { widthPx, heightPx }
                                                                                                                                - isDeviceReady() → boolean
- `input-actions.port.ts`
                                                                                                                                - performTap(x, y)
                                                                                                                                - performSwipe(startX, startY, endX, endY, durationMs)
                                                                                                                                - performLongPress(x, y, durationMs)
                                                                                                                                - performTextInput(text)
- `navigation.port.ts`
                                                                                                                                - performBack()
                                                                                                                                - pressHome()
- `idle-detector.port.ts`
                                                                                                                                - waitIdle(minQuietMillis, maxWaitMillis) → number

All interfaces will carry TSDoc copied from `driver_port.py` and `android_appium_tools.py` (method-level docstrings preserved verbatim). If Python docstrings exceed a single method, include a concise port-level summary plus method-level docstrings.

## Adapter Design (WebDriverIO)

- `adapters/appium/webdriverio/session.adapter.ts`
                                                                                                                                - Creates/closes sessions via `remote()`; holds the bound WDIO `Browser` instance.
                                                                                                                                - Provides `SessionContext` to other adapters via constructor.
- One adapter per port (keeps classes small):
                                                                                                                                - `adapters/appium/webdriverio/perception.adapter.ts`
                                                                                                                                - `adapters/appium/webdriverio/input-actions.adapter.ts`
                                                                                                                                - `adapters/appium/webdriverio/navigation.adapter.ts`
                                                                                                                                - `adapters/appium/webdriverio/device-info.adapter.ts`
                                                                                                                                - `adapters/appium/webdriverio/app-lifecycle.adapter.ts`
                                                                                                                                - `adapters/appium/webdriverio/idle-detector.adapter.ts`
- Map each adapter method to the equivalent in `android_appium_tools.py` (converted to WDIO). Keep docstrings as TSDoc.
- Error mapping: convert Python exceptions (`DeviceOfflineError`, `AppNotInstalledError`, etc.) into typed TS error classes under `backend/agent/adapters/appium/errors.ts` and throw accordingly.

## Compatibility Façade (temporary)

- `ports/appium/driver.facade.ts` implements the legacy `DriverPort` by delegating to granular ports through composition.
- Used to avoid big-bang changes; allows node-by-node migration.

## Node Migrations (incremental)

- `nodes/setup/ensure-device.ts`: switch to `SessionPort.ensureDevice`.
- `nodes/setup/launch-or-attach.ts`: switch to `AppLifecyclePort.launchApp`.
- `nodes/setup/wait-idle.ts`: switch to `IdleDetectorPort.waitIdle`.
- `nodes/main/perceive.ts`: switch to `PerceptionPort` + `DeviceInfoPort`.
- `nodes/main/act.ts`: switch to `InputActionsPort` + `NavigationPort`.
- After nodes are migrated and tests pass, remove the façade and old ports.

## Docstring Preservation Policy

- Copy the exact Python docstrings and inline comments into TSDoc blocks above the corresponding TS interfaces and methods.
- Maintain line breaks and bulleting; only adapt code identifiers and types where necessary.
- If a Python docstring spans multiple concerns, place the full text on the closest matching port; add a short cross-reference link in other ports.

## Types & DTOs

- Reuse existing DTOs: `DeviceConfiguration`, `DeviceRuntimeContext`, `ScreenshotData`, `UiHierarchyData`, `ApplicationForegroundContext`.
- Add missing DTOs (e.g., `ScreenDimensions`, `AppiumCapabilities`) under `backend/agent/run/types.ts` if needed.
- No `any`. Use discriminated unions or `Record<string, unknown>` for dynamic Appium capabilities.

## Testing & Fakes

- Split `adapters/fakes/fake-driver.ts` into fakes per port: `fake-session.port.ts`, `fake-perception.port.ts`, etc.
- Unit tests for each adapter method (happy path + error mapping).
- Golden tests for `perceive` artifacts unchanged.

## Migration Strategy

1) Introduce new ports with TSDoc; implement adapters; add façade for legacy `DriverPort`.

2) Migrate nodes one-by-one to narrow ports; keep façade wired until all are migrated.

3) Replace `adapters/fakes/fake-driver.ts` usages with new fakes.

4) Remove legacy `ports/appium/driver.ts` and `driver.port.ts` after tests pass.

## Example TSDoc Preservation

```ts
/**
 * Capture UI hierarchy as XML/JSON.
 * Returns: XML string (Android) or JSON (ipkOS).
 * Raises: TimeoutError if capture timed out.
 */
export interface PerceptionPort { dumpUiHierarchy(): Promise<UiHierarchyData>; }
```

## Implementation Notes

- Client: WebDriverIO latest (Appium 2; UiAutomator2 on Android).
- Capabilities: map `DeviceConfiguration` → WDIO options; avoid hardcoded URLs.
- Keep file sizes small (<250 lines). Split helpers (selectors, gestures) if needed.

### To-dos

- [x] Extract Python docstrings, map to ports/methods, prepare TSDoc blocks
- [x] Create granular Appium port interfaces with preserved TSDoc
- [x] Implement WebDriverIO session adapter and context
- [x] Implement perception adapter methods (screenshot, source)
- [x] Implement input actions adapter (tap, swipe, long-press, text)
- [x] Implement navigation adapter (back, home)
- [x] Implement app lifecycle adapter (launch, restart, current app)
- [x] Implement device info adapter (screen size, readiness)
- [x] Implement idle detector adapter (waitIdle) with heuristics
- [x] Add typed error classes mapping from Python exceptions
- [x] Create fakes per port and update tests
- [x] Add legacy DriverPort façade delegating to new ports
- [x] Migrate ensure-device node to SessionPort
- [x] Migrate launch-or-attach node to AppLifecyclePort
- [x] Migrate wait-idle node to IdleDetectorPort
- [x] Migrate perceive node to Perception+DeviceInfo ports
- [x] Migrate act node to InputActions+Navigation ports
- [ ] Remove old driver ports and façade after migrations (pending orchestrator integration)
- [x] Document architecture, ports, and usage in README