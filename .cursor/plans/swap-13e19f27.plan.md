<!-- 13e19f27-02f6-4d2f-bc09-0e2e1154817a c5782321-bc6a-452e-8666-a5da86e7e6df -->
# Driver Swap Plan — Default to @wdio/webdriver (standalone), keep WDIO as stub

### Goal

- Default all agent nodes to use the thin @wdio/webdriver client (no testrunner), talking to Appium Server.
- Keep existing WebdriverIO-based adapters in-place but not active by default (post‑MVP).
- Scope: POC on Android (UiAutomator2). iOS (XCUITest) scaffolding only.

### Key Changes

- **Dependencies**
  - Add `@wdio/webdriver` to `backend/package.json`. Keep `webdriverio` for the stubbed adapter.
- **New adapter family (thin client)**
  - Create `backend/agent/adapters/appium/webdriver/` with:
    - `session.adapter.ts` (create/destroy session)
    - `input-actions.adapter.ts` (tap, type, swipe minimal)
    - `navigation.adapter.ts` (back, home)
    - `perception.adapter.ts` (screenshot, page source)
    - `device-info.adapter.ts` (window size)
    - `idle-detector.adapter.ts` (simple heuristics, no implicit waits)
    - `session-context.ts` (exports driver + capabilities)
- **Type clarity (no Browser confusion)**
  - Prefer an alias for the driver type in the new adapter:
```ts
// New (adapter-local)
import type { WebDriver } from '@wdio/webdriver';
export type MobileDriver = WebDriver;
export interface SessionContext {
  driver: MobileDriver;
  capabilities: Record<string, unknown>;
}
```

- **Protocol mapping (Android POC)**
  - Tap: use W3C `performActions` (pointer) to avoid WDIO `touchAction` helper.
  - Back: `driver.back()` (W3C).
  - Home: `driver.execute('mobile: pressKey', { keycode: 3 })` (Android).
  - Screenshot: `driver.takeScreenshot()` (base64 → store via storage port later; return `artifactId` post‑MVP).
  - UI dump: `driver.getPageSource()` (store later; return `artifactId` post‑MVP).
  - Window size: `driver.getWindowSize()`.
- **Adapter selection (configurable, default to new)**
  - In the adapters/ports wiring (where `AgentPorts` are constructed), add a small switch on a config enum, defaulting to `WebDriverStandalone`:
```ts
// Pseudocode
export enum DriverImpl { WebDriverStandalone, WebdriverIO }
const impl = config.driverImpl ?? DriverImpl.WebDriverStandalone;
```

  - Build `AgentPorts` using the new webdriver adapters when `WebDriverStandalone`, else WDIO stubs.
- **Keep WDIO adapters as stub**
  - Leave files under `backend/agent/adapters/appium/webdriverio/*` untouched.
  - Ensure they can still compile; they are just not selected by default.
- **iOS scaffolding (MVP follow-up)**
  - Add method placeholders using `driver.execute('mobile: ...')` with TODOs guarded by compile‑time types, no runtime dead calls.

### Non-goals (for this swap)

- No removal/refactor of existing WDIO code.
- No changes to domain ports’ shape beyond driver binding.
- No artifact storage change yet (will switch to returning `artifactId` in a later task).

### Risks & Mitigations

- **Protocol parity gaps**: Some WDIO helpers (e.g., `touchAction`, `pressKeyCode`) are conveniences. Mitigate by using W3C actions or `mobile:` extensions explicitly.
- **Hidden waits**: Ensure no implicit retries/timeouts; all budgets come from `AgentState` and are passed through ports.
- **Type drift**: Centralize `MobileDriver` alias inside the new adapter to avoid leaking vendor types.

### Affected Files (high-signal)

- `backend/package.json` (add `@wdio/webdriver`)
- New: `backend/agent/adapters/appium/webdriver/*`
- Adapter wiring site (where `AgentPorts` are built), e.g., `backend/agent/nodes/registry.ts` or builder used by worker context
- No deletions/edits to `backend/agent/adapters/appium/webdriverio/*`

### Acceptance for POC

- EnsureDevice works on Android using the new adapter and returns a valid `deviceRuntimeContextId`.
- One tap action and one screenshot captured via new adapter.
- WDIO adapter remains selectable via config but off by default.

### To-dos

- [ ] Add @wdio/webdriver to backend dependencies; keep webdriverio installed
- [ ] Create session.adapter.ts to open/close Appium sessions via @wdio/webdriver
- [ ] Implement input-actions, navigation, perception, device-info, idle-detector using W3C/mobile commands
- [ ] Add config enum switch to build AgentPorts with webdriver by default; keep WDIO selectable
- [ ] Run EnsureDevice→Tap→Screenshot using new adapter on Android
- [ ] Add iOS-specific placeholders (XCUITest) guarded; no runtime use yet