<!-- 12e57602-46d9-469e-b36e-da7ca2226316 b310d73c-2393-41fc-baba-ea4dcb871b23 -->
# Phase 1 — Wrap NodeEngine with XState v5 (non-invasive)

## Goal

Adopt XState v5 to orchestrate the agent run loop, while preserving current nodes, ports, adapters, handlers, mappers, and state model. Use a feature flag to switch between the existing AgentRunner and the new XState driver. Reference: [XState v5](https://github.com/statelyai/xstate).

## What stays the same

- `backend/agent/nodes/**`: handlers, mappers, policies, node executors
- `backend/agent/ports/**` and adapters
- `backend/agent/domain/**` (AgentState, events, budgets)
- `backend/agent/engine/node-engine.ts` (still used for node execution in Phase 1)

## What changes

- Introduce an XState machine to own the orchestration loop (retry/backoff/backtrack/next), delegating a single step to `NodeEngine.runOnce`.
- Replace `AgentRunner` usage in `orchestrator/worker.ts` with a driver that starts an XState actor (behind a feature flag).

## Dependencies

- Add `xstate@^5` to `backend/package.json` (Bun-managed). No other runtime deps.

## New files

- `backend/agent/engine/xstate/machine.ts`
- Typed `createMachine` with context `{ state: AgentState; ports: AgentPorts; ctx: AgentContext; seed: () => number; callbacks: AgentRunnerCallbacks<AgentNodeName>; shouldStop: () => Promise<{ stop: boolean; reason: StopReason | null }>; }`
- States: `idle` → `executing` (invoke runOnce) → `decide` → (`waitingRetry` | `backtracking` | `transitioning` | `finished` | `failed`)
- `after` transition in `waitingRetry` using `retryDelayMs` from engine result
- Actions: persist via `callbacks.onPersist`, then emit `onAttempt`
- Guards: stop conditions (budgets/cancel), terminal success/failure
- `backend/agent/engine/xstate/types.ts`
- Narrowed event union for XState (e.g., `START`, `ATTEMPT_DONE`, `STOP_REQUESTED`)
- `backend/agent/engine/xstate/services.ts`
- Service to call `engine.runOnce` (pure promise), strongly typed

## Touch points

- `backend/agent/orchestrator/worker.ts`
- Feature-flagged branching: `AGENT_DRIVER=xstate|runner`
- For xstate: build `NodeEngine`, create machine actor with initial node, start, await terminal state
- Maintain lease heartbeats and budgets as today; pass `shouldStop` into machine
- `backend/agent/engine/agent-runner.ts`
- Keep intact for fallback; extract shared `AgentRunnerCallbacks` type for reuse
- `backend/agent/nodes/registry.ts`
- No change in Phase 1

## Machine sketch (essential)

- Context: `state, ports, ctx, seed, callbacks, shouldStop`
- invoke `runOnce` in `executing` with `{ currentNode: context.state.nodeName }`
- on done → event `ATTEMPT_DONE(result)`; transition to `decide`
- `decide` guards:
- if `result.retryDelayMs !== null && result.nextNode === currentNode` → `waitingRetry`
- else if `result.backtracked` → set `state.nodeName = result.nextNode` → `executing`
- else if `result.outcome === 'SUCCESS' && result.nextNode` → set node → `executing`
- else if `result.outcome === 'SUCCESS' && !result.nextNode` → `finished`
- else if `result.outcome === 'FAILURE' && !result.nextNode` → `failed`

## Logging & persistence

- Use `encore.dev/log` with `{ module: 'agent', actor: 'worker', runId, nodeName, stepOrdinal }`
- After each attempt: call `callbacks.onPersist(state, events, nodeName)` then `callbacks.onAttempt(engineResult)`

## Feature flag

- Read `process.env.AGENT_DRIVER` (default `runner`)
- Optional Encore config binding if preferred later

## Tests (Phase 1)

- Unit: machine transitions for retry/backtrack/success/failure (fake engine)
- Integration: start → LaunchOrAttach → Perceive → WaitIdle → SwitchPolicy → Stop path completes; logs persisted

## Acceptance criteria

- Toggle between drivers without code changes
- Functional parity with `AgentRunner` on green path
- Structured logs preserved
- No `any` types; all DTOs/handlers maintain purpose comments

## Phase 2 (follow-up, not in this PR)

- Move retry/backoff/backtrack policy from engine into XState (guards/after)
- Replace `AgentRunner` fully; simplify `transition-policy.ts`
- Add Stately visualization artifact for the machine

### To-dos

- [ ] Add xstate@^5 to backend/package.json (Bun), install
- [ ] Create typed XState event/context types file
- [ ] Implement runOnce invoke service wrapper
- [ ] Implement machine with executing/decide/waitingRetry/finished/failed states
- [ ] Wire encore logging and callbacks.onPersist/onAttempt in machine
- [ ] Add AGENT_DRIVER env flag, default runner
- [ ] Branch worker to start machine actor when flag=xstate
- [ ] Preserve AgentRunner path for rollback
- [ ] Add unit tests for machine transitions using fake engine
- [ ] End-to-end test for splash→waitIdle→switchPolicy→stop path
- [ ] Document driver flag, start instructions, and diagrams